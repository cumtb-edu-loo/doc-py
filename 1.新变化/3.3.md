# Python 3.3 有什么新变化¶

本文介绍了Python 3.3相比 3.2 的新增特性。Python 3.3于2012年9月29日发布。有关完整详细信息，请参见 [changelog](https://docs.python.org/3.3/whatsnew/changelog.md)。

参见

[**PEP 398**](https://peps.python.org/pep-0398/) \- Python 3.3 发布计划

## 摘要 -- 发布重点¶

新的语法特性：

  * 新增 `yield from` 表达式用于 生成器委托。

  * `u'unicode'` 语法重新被接受用于 [`str`](stdtypes.md#str "str") 对象。

新的库模块：

  * [`faulthandler`](faulthandler.md#module-faulthandler "faulthandler: Dump the Python traceback.") (帮助调试低层级的崩溃)

  * [`ipaddress`](3.标准库/ipaddress.md#module-ipaddress "ipaddress: IPv4/IPv6 manipulation library.") (代表 IP 地址和掩码的高层级对象)

  * [`lzma`](lzma.md#module-lzma "lzma: A Python wrapper for the liblzma compression library.") (使用 XZ / LZMA 算法压缩数据)

  * [`unittest.mock`](unittest.mock.md#module-unittest.mock "unittest.mock: Mock object library.") (使用模拟对象替换你的受测试系统中的某些部分)

  * [`venv`](3.标准库/venv.md#module-venv "venv: Creation of virtual environments.") (Python 虚拟环境，类似于流行的 `virtualenv` 包)

新的内置特性：

  * 重写 I/O 异常的层次结构.

实现的改进：

  * 基于 [`importlib`](importlib.md#module-importlib "importlib: The implementation of the import machinery.") 重写 import machinery

  * 更紧凑的 Unicode 字符串。

  * 更紧凑的 属性字典。

显著改进的库模块：

  * 针对 decimal 模块的 C 加速器。

  * email 模块中更好的 Unicode 处理 ([暂定](../glossary.md#term-provisional-package))。

安全改进：

  * 哈希随机化被默认启用。

请继续阅读有关面向用户的改变的详细清单。

## PEP 405: 虚拟环境¶

Virtual environments help create separate Python setups while sharing a system-wide base install, for ease of maintenance. Virtual environments have their own set of private site packages (i.e. locally installed libraries), and are optionally segregated from the system-wide site packages. Their concept and implementation are inspired by the popular `virtualenv` third-party package, but benefit from tighter integration with the interpreter core.

This PEP adds the [`venv`](3.标准库/venv.md#module-venv "venv: Creation of virtual environments.") module for programmatic access, and the `pyvenv` script for command-line access and administration. The Python interpreter checks for a `pyvenv.cfg`, file whose existence signals the base of a virtual environment's directory tree.

参见

[**PEP 405**](https://peps.python.org/pep-0405/) \- Python虚拟环境

    

~~~
PEP 由 Carl Meyer 撰写 ; 由 Carl Meyer 和 Vinay Sajip 实现。

## PEP 420: 隐式命名空间包¶

Native support for package directories that don't require `__init__.py` marker files and can automatically span multiple path segments (inspired by various third party approaches to namespace packages, as described in [**PEP 420**](https://peps.python.org/pep-0420/))

参见

[**PEP 420**](https://peps.python.org/pep-0420/) \- 隐式命名空间包
~~~
    

~~~
PEP 由 Eric V. Smith 撰写，由 Eric V. Smith 和 Barry Warsaw 实现

## PEP 3118: 新的内存视图实现和缓冲协议文档¶

[**PEP 3118**](https://peps.python.org/pep-3118/) 的实现已获得大幅改进。

The new memoryview implementation comprehensively fixes all ownership and lifetime issues of dynamically allocated fields in the Py_buffer struct that led to multiple crash reports. Additionally, several functions that crashed or returned incorrect results for non-contiguous or multi-dimensional input have been fixed.

The memoryview object now has a PEP-3118 compliant getbufferproc() that checks the consumer's request type. Many new features have been added, most of them work in full generality for non-contiguous arrays and arrays with suboffsets.

The documentation has been updated, clearly spelling out responsibilities for both exporters and consumers. Buffer request flags are grouped into basic and compound flags. The memory layout of non-contiguous and multi-dimensional NumPy-style arrays is explained.

### 相关特性¶

  * 现在 struct 模块语法中所有原生单字符格式指示符（可以选择添加 '@' 前缀）均受到支持。

  * 在某些限制条件下，cast() 方法允许改变 C 连续数组的格式和形状。

  * Multi-dimensional list representations are supported for any array type.

  * Multi-dimensional comparisons are supported for any array type.

  * One-dimensional memoryviews of hashable (read-only) types with formats B, b or c are now hashable. (Contributed by Antoine Pitrou in [bpo-13411](https://bugs.python.org/issue?@action=redirect&bpo=13411).)

  * Arbitrary slicing of any 1-D arrays type is supported. For example, it is now possible to reverse a memoryview in O(1) by using a negative step.

### API 的变化¶

  * 官方的最大维度数量限制已更改为 64。

  * The representation of empty shape, strides and suboffsets is now an empty tuple instead of `None`.

  * Accessing a memoryview element with format 'B' (unsigned bytes) now returns an integer (in accordance with the struct module syntax). For returning a bytes object the view must be cast to 'c' first.

  * memoryview comparisons now use the logical structure of the operands and compare all array elements by value. All format strings in struct module syntax are supported. Views with unrecognised format strings are still permitted, but will always compare as unequal, regardless of view contents.

  * For further changes see Build and C API Changes and Porting C code.

（由 Stefan Krah 在 [bpo-10181](https://bugs.python.org/issue?@action=redirect&bpo=10181) 中贡献。）

参见

[**PEP 3118**](https://peps.python.org/pep-3118/) \- 修改缓冲区协议

## PEP 393: 灵活的字符串表示¶

The Unicode string type is changed to support multiple internal representations, depending on the character with the largest Unicode ordinal (1, 2, or 4 bytes) in the represented string. This allows a space-efficient representation in common cases, but gives access to full UCS-4 on all systems. For compatibility with existing APIs, several representations may exist in parallel; over time, this compatibility should be phased out.

On the Python side, there should be no downside to this change.

On the C API side, [**PEP 393**](https://peps.python.org/pep-0393/) is fully backward compatible. The legacy API should remain available at least five years. Applications using the legacy API will not fully benefit of the memory reduction, or - worse - may use a bit more memory, because Python may have to maintain two versions of each string (in the legacy format and in the new efficient storage).

### 功能¶

由 [**PEP 393**](https://peps.python.org/pep-0393/) 引入的改变如下:

  * Python now always supports the full range of Unicode code points, including non-BMP ones (i.e. from `U+0000` to `U+10FFFF`). The distinction between narrow and wide builds no longer exists and Python now behaves like a wide build, even under Windows.

  * With the death of narrow builds, the problems specific to narrow builds have also been fixed, for example:

    * [`len()`](../library/functions.md#len "len") now always returns 1 for non-BMP characters, so `len('\U0010FFFF') == 1`;

    * surrogate pairs are not recombined in string literals, so `'\uDBFF\uDFFF' != '\U0010FFFF'`;

    * indexing or slicing non-BMP characters returns the expected value, so `'\U0010FFFF'[0]` now returns `'\U0010FFFF'` and not `'\uDBFF'`;

    * all other functions in the standard library now correctly handle non-BMP code points.

  * The value of [`sys.maxunicode`](../library/sys.md#sys.maxunicode "sys.maxunicode") is now always `1114111` (`0x10FFFF` in hexadecimal). The `PyUnicode_GetMax()` function still returns either `0xFFFF` or `0x10FFFF` for backward compatibility, and it should not be used with the new Unicode API (see [bpo-13054](https://bugs.python.org/issue?@action=redirect&bpo=13054)).

  * The `./configure` flag `--with-wide-unicode` has been removed.

### Performance and resource usage¶

The storage of Unicode strings now depends on the highest code point in the string:

  * pure ASCII and Latin1 strings (`U+0000-U+00FF`) use 1 byte per code point;

  * BMP strings (`U+0000-U+FFFF`) use 2 bytes per code point;

  * non-BMP strings (`U+10000-U+10FFFF`) use 4 bytes per code point.

The net effect is that for most applications, memory usage of string storage should decrease significantly - especially compared to former wide unicode builds - as, in many cases, strings will be pure ASCII even in international contexts (because many strings store non-human language data, such as XML fragments, HTTP headers, JSON-encoded data, etc.). We also hope that it will, for the same reasons, increase CPU cache efficiency on non-trivial applications. The memory usage of Python 3.3 is two to three times smaller than Python 3.2, and a little bit better than Python 2.7, on a Django benchmark (see the PEP for details).

参见

[**PEP 393**](https://peps.python.org/pep-0393/) \- 灵活的字符串表示
~~~
    

~~~
PEP 由 Martin von Löwis 撰写 ; 由 Torsten Becker 和 Martin von Löwis 实现。

## PEP 397: 适用于Windows的Python启动器¶

The Python 3.3 Windows installer now includes a `py` launcher application that can be used to launch Python applications in a version independent fashion.

This launcher is invoked implicitly when double-clicking `*.py` files. If only a single Python version is installed on the system, that version will be used to run the file. If multiple versions are installed, the most recent version is used by default, but this can be overridden by including a Unix-style "shebang line" in the Python script.

The launcher can also be used explicitly from the command line as the `py` application. Running `py` follows the same version selection rules as implicitly launching scripts, but a more specific version can be selected by passing appropriate arguments (such as `-3` to request Python 3 when Python 2 is also installed, or `-2.6` to specifically request an earlier Python version when a more recent version is installed).

In addition to the launcher, the Windows installer now includes an option to add the newly installed Python to the system PATH. (Contributed by Brian Curtin in [bpo-3561](https://bugs.python.org/issue?@action=redirect&bpo=3561).)

参见

[**PEP 397**](https://peps.python.org/pep-0397/) \- 适用于Windows的Python启动器
~~~
    

~~~
PEP 由 Mark Hammond 和 Martin v. Löwis 撰写 ; 由 Vinay Sajip实现。

启动器文档: [适用于Windows的Python启动器](../using/windows.md#launcher)

安装器 PATH 修改: [查找Python可执行文件](../using/windows.md#windows-path-mod)

## PEP 3151: 重写 OS 和 IO 异常的层次结构¶

The hierarchy of exceptions raised by operating system errors is now both simplified and finer-grained.

You don't have to worry anymore about choosing the appropriate exception type between [`OSError`](../library/exceptions.md#OSError "OSError"), [`IOError`](../library/exceptions.md#IOError "IOError"), [`EnvironmentError`](../library/exceptions.md#EnvironmentError "EnvironmentError"), [`WindowsError`](../library/exceptions.md#WindowsError "WindowsError"), `mmap.error`, [`socket.error`](../library/socket.md#socket.error "socket.error") or [`select.error`](../library/select.md#select.error "select.error"). All these exception types are now only one: [`OSError`](../library/exceptions.md#OSError "OSError"). The other names are kept as aliases for compatibility reasons.

Also, it is now easier to catch a specific error condition. Instead of inspecting the `errno` attribute (or `args[0]`) for a particular constant from the [`errno`](../library/errno.md#module-errno "errno: Standard errno system symbols.") module, you can catch the adequate [`OSError`](../library/exceptions.md#OSError "OSError") subclass. The available subclasses are the following:

  * [`BlockingIOError`](../library/exceptions.md#BlockingIOError "BlockingIOError")

  * [`ChildProcessError`](../library/exceptions.md#ChildProcessError "ChildProcessError")

  * [`ConnectionError`](../library/exceptions.md#ConnectionError "ConnectionError")

  * [`FileExistsError`](../library/exceptions.md#FileExistsError "FileExistsError")

  * [`FileNotFoundError`](../library/exceptions.md#FileNotFoundError "FileNotFoundError")

  * [`InterruptedError`](../library/exceptions.md#InterruptedError "InterruptedError")

  * [`IsADirectoryError`](../library/exceptions.md#IsADirectoryError "IsADirectoryError")

  * [`NotADirectoryError`](../library/exceptions.md#NotADirectoryError "NotADirectoryError")

  * [`PermissionError`](../library/exceptions.md#PermissionError "PermissionError")

  * [`ProcessLookupError`](../library/exceptions.md#ProcessLookupError "ProcessLookupError")

  * [`TimeoutError`](../library/exceptions.md#TimeoutError "TimeoutError")

并且 [`ConnectionError`](../library/exceptions.md#ConnectionError "ConnectionError") 本身具有细粒度的子类:

  * [`BrokenPipeError`](../library/exceptions.md#BrokenPipeError "BrokenPipeError")

  * [`ConnectionAbortedError`](../library/exceptions.md#ConnectionAbortedError "ConnectionAbortedError")

  * [`ConnectionRefusedError`](../library/exceptions.md#ConnectionRefusedError "ConnectionRefusedError")

  * [`ConnectionResetError`](../library/exceptions.md#ConnectionResetError "ConnectionResetError")

Thanks to the new exceptions, common usages of the [`errno`](../library/errno.md#module-errno "errno: Standard errno system symbols.") can now be avoided. For example, the following code written for Python 3.2:
~~~
    
    
~~~
from errno import ENOENT, EACCES, EPERM

try:
    with open("document.txt") as f:
        content = f.read()
except IOError as err:
    if err.errno == ENOENT:
        print("document.txt file is missing")
    elif err.errno in (EACCES, EPERM):
        print("You are not allowed to read document.txt")
    else:
        raise
~~~

can now be written without the [`errno`](errno.md#module-errno "errno: Standard errno system symbols.") import and without manual inspection of exception attributes:

    
    
~~~
try:
    with open("document.txt") as f:
        content = f.read()
except FileNotFoundError:
    print("document.txt file is missing")
except PermissionError:
    print("You are not allowed to read document.txt")
~~~

参见

[**PEP 3151**](https://peps.python.org/pep-3151/) \- 重写 OS 和 IO 异常的层次结构

    

~~~
PEP 由 Antoine Pitrou 撰写并实现

## PEP 380: 委托给子生成器的语法¶

PEP 380 adds the `yield from` expression, allowing a [generator](../glossary.md#term-generator) to delegate part of its operations to another generator. This allows a section of code containing [`yield`](../reference/simple_stmts.md#yield) to be factored out and placed in another generator. Additionally, the subgenerator is allowed to return with a value, and the value is made available to the delegating generator.

While designed primarily for use in delegating to a subgenerator, the `yield from` expression actually allows delegation to arbitrary subiterators.

For simple iterators, `yield from iterable` is essentially just a shortened form of `for item in iterable: yield item`:
~~~
    
    
~~~shell
>>> def g(x):
...     yield from range(x, 0, -1)
...     yield from range(x)
...
>>> list(g(5))
[5, 4, 3, 2, 1, 0, 1, 2, 3, 4]
~~~

However, unlike an ordinary loop, `yield from` allows subgenerators to receive sent and thrown values directly from the calling scope, and return a final value to the outer generator:

    
    
~~~shell
>>> def accumulate():
...     tally = 0
...     while 1:
...         next = yield
...         if next is None:
...             return tally
...         tally += next
...
>>> def gather_tallies(tallies):
...     while 1:
...         tally = yield from accumulate()
...         tallies.append(tally)
...
>>> tallies = []
>>> acc = gather_tallies(tallies)
>>> next(acc)  # Ensure the accumulator is ready to accept values
>>> for i in range(4):
...     acc.send(i)
...
>>> acc.send(None)  # Finish the first tally
>>> for i in range(5):
...     acc.send(i)
...
>>> acc.send(None)  # Finish the second tally
>>> tallies
[6, 10]
~~~

The main principle driving this change is to allow even generators that are designed to be used with the `send` and `throw` methods to be split into multiple subgenerators as easily as a single large function can be split into multiple subfunctions.

参见

[**PEP 380**](https://peps.python.org/pep-0380/) \- 委托给子生成器的语法

    

~~~
PEP 由 Greg Ewing 撰写，由 Greg Ewing 实现。由 Renaud Blanch，Ryan Kelly 和 Nick Coghlan 集成到3.3，由 Zbigniew Jędrzejewski-Szmek 和 Nick Coghlan 编写文档

## PEP 409: 清除异常上下文¶

PEP 409 introduces new syntax that allows the display of the chained exception context to be disabled. This allows cleaner error messages in applications that convert between exception types:
~~~
    
    
~~~shell
>>> class D:
...     def __init__(self, extra):
...         self._extra_attributes = extra
...     def __getattr__(self, attr):
...         try:
...             return self._extra_attributes[attr]
...         except KeyError:
...             raise AttributeError(attr) from None
...
>>> D({}).x
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "<stdin>", line 8, in __getattr__
AttributeError: x
~~~

Without the `from None` suffix to suppress the cause, the original exception would be displayed by default:

    
    
~~~shell
>>> class C:
...     def __init__(self, extra):
...         self._extra_attributes = extra
...     def __getattr__(self, attr):
...         try:
...             return self._extra_attributes[attr]
...         except KeyError:
...             raise AttributeError(attr)
...
>>> C({}).x
Traceback (most recent call last):
  File "<stdin>", line 6, in __getattr__
KeyError: 'x'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "<stdin>", line 8, in __getattr__
AttributeError: x
~~~

No debugging capability is lost, as the original exception context remains available if needed (for example, if an intervening library has incorrectly suppressed valuable underlying details):

    
    
~~~shell
>>> try:
...     D({}).x
... except AttributeError as exc:
...     print(repr(exc.__context__))
...
KeyError('x',)
~~~

参见

[**PEP 409**](https://peps.python.org/pep-0409/) \- 清除异常上下文

    

~~~
PEP 由 Ethan Furman 撰写 ，由 Ethan Furman 和 Nick Coghlan 实现。

## PEP 414: 显式的Unicode文本¶

To ease the transition from Python 2 for Unicode aware Python applications that make heavy use of Unicode literals, Python 3.3 once again supports the "`u`" prefix for string literals. This prefix has no semantic significance in Python 3, it is provided solely to reduce the number of purely mechanical changes in migrating to Python 3, making it easier for developers to focus on the more significant semantic changes (such as the stricter default separation of binary and text data).

参见

[**PEP 414**](https://peps.python.org/pep-0414/) \- 显式的Unicode文本
~~~
    

~~~
PEP 由 Armin Ronacher 撰写

## PEP 3155: 类和函数的限定名称¶

Functions and class objects have a new `__qualname__` attribute representing the "path" from the module top-level to their definition. For global functions and classes, this is the same as `__name__`. For other functions and classes, it provides better information about where they were actually defined, and how they might be accessible from the global scope.

Example with (non-bound) methods:
~~~
    
    
~~~shell
>>> class C:
...     def meth(self):
...         pass
...
>>> C.meth.__name__
'meth'
>>> C.meth.__qualname__
'C.meth'
~~~

Example with nested classes:

    
    
~~~shell
>>> class C:
...     class D:
...         def meth(self):
...             pass
...
>>> C.D.__name__
'D'
>>> C.D.__qualname__
'C.D'
>>> C.D.meth.__name__
'meth'
>>> C.D.meth.__qualname__
'C.D.meth'
~~~

Example with nested functions:

    
    
~~~shell
>>> def outer():
...     def inner():
...         pass
...     return inner
...
>>> outer().__name__
'inner'
>>> outer().__qualname__
'outer.<locals>.inner'
~~~

The string representation of those objects is also changed to include the new, more precise information:

    
    
~~~shell
>>> str(C.D)
"<class '__main__.C.D'>"
>>> str(C.D.meth)
'<function C.D.meth at 0x7f46b9fe31e0>'
~~~

参见

[**PEP 3155**](https://peps.python.org/pep-3155/) \- 类和函数的限定名称

    

~~~
PEP 由 Antoine Pitrou 撰写并实现

## PEP 412: Key-Sharing Dictionary¶

Dictionaries used for the storage of objects' attributes are now able to share part of their internal storage between each other (namely, the part which stores the keys and their respective hashes). This reduces the memory consumption of programs creating many instances of non-builtin types.

参见

[**PEP 412**](https://peps.python.org/pep-0412/) \- Key-Sharing Dictionary
~~~
    

~~~
PEP 由 Mark Shannon 撰写并实现。

## PEP 362: 函数签名对象¶

A new function [`inspect.signature()`](../library/inspect.md#inspect.signature "inspect.signature") makes introspection of python callables easy and straightforward. A broad range of callables is supported: python functions, decorated or not, classes, and [`functools.partial()`](../library/functools.md#functools.partial "functools.partial") objects. New classes [`inspect.Signature`](../library/inspect.md#inspect.Signature "inspect.Signature"), [`inspect.Parameter`](../library/inspect.md#inspect.Parameter "inspect.Parameter") and [`inspect.BoundArguments`](../library/inspect.md#inspect.BoundArguments "inspect.BoundArguments") hold information about the call signatures, such as, annotations, default values, parameters kinds, and bound arguments, which considerably simplifies writing decorators and any code that validates or amends calling signatures or arguments.

参见

[**PEP 362**](https://peps.python.org/pep-0362/): - 函数签名对象
~~~
    

~~~
PEP 由 Brett Cannon，Yury Selivanov，Larry Hastings，Jiwon Seo 撰写，由 Yury Selivanov 实现

## PEP 421: 添加 sys.implementation¶

A new attribute on the [`sys`](../library/sys.md#module-sys "sys: Access system-specific parameters and functions.") module exposes details specific to the implementation of the currently running interpreter. The initial set of attributes on [`sys.implementation`](../library/sys.md#sys.implementation "sys.implementation") are `name`, `version`, `hexversion`, and `cache_tag`.

The intention of `sys.implementation` is to consolidate into one namespace the implementation-specific data used by the standard library. This allows different Python implementations to share a single standard library code base much more easily. In its initial state, `sys.implementation` holds only a small portion of the implementation-specific data. Over time that ratio will shift in order to make the standard library more portable.

One example of improved standard library portability is `cache_tag`. As of Python 3.3, `sys.implementation.cache_tag` is used by [`importlib`](../library/importlib.md#module-importlib "importlib: The implementation of the import machinery.") to support [**PEP 3147**](https://peps.python.org/pep-3147/) compliance. Any Python implementation that uses `importlib` for its built-in import system may use `cache_tag` to control the caching behavior for modules.

### SimpleNamespace¶

The implementation of `sys.implementation` also introduces a new type to Python: [`types.SimpleNamespace`](../library/types.md#types.SimpleNamespace "types.SimpleNamespace"). In contrast to a mapping-based namespace, like [`dict`](../library/stdtypes.md#dict "dict"), `SimpleNamespace` is attribute-based, like [`object`](../library/functions.md#object "object"). However, unlike `object`, `SimpleNamespace` instances are writable. This means that you can add, remove, and modify the namespace through normal attribute access.

参见

[**PEP 421**](https://peps.python.org/pep-0421/) \- 添加 sys.implementation
~~~
    

~~~
PEP 由 Eric Snow 撰写并实现

## 使用 importlib 作为导入的实现¶

[bpo-2377](https://bugs.python.org/issue?@action=redirect&bpo=2377) \- Replace __import__ w/ importlib.__import__ [bpo-13959](https://bugs.python.org/issue?@action=redirect&bpo=13959) \- Re-implement parts of `imp` in pure Python [bpo-14605](https://bugs.python.org/issue?@action=redirect&bpo=14605) \- Make import machinery explicit [bpo-14646](https://bugs.python.org/issue?@action=redirect&bpo=14646) \- Require loaders set __loader__ and __package__

The [`__import__()`](../library/functions.md#import__ "__import__") function is now powered by [`importlib.__import__()`](../library/importlib.md#importlib.__import__ "importlib.__import__"). This work leads to the completion of "phase 2" of [**PEP 302**](https://peps.python.org/pep-0302/). There are multiple benefits to this change. First, it has allowed for more of the machinery powering import to be exposed instead of being implicit and hidden within the C code. It also provides a single implementation for all Python VMs supporting Python 3.3 to use, helping to end any VM-specific deviations in import semantics. And finally it eases the maintenance of import, allowing for future growth to occur.

For the common user, there should be no visible change in semantics. For those whose code currently manipulates import or calls import programmatically, the code changes that might possibly be required are covered in the Porting Python code section of this document.

### New APIs¶

One of the large benefits of this work is the exposure of what goes into making the import statement work. That means the various importers that were once implicit are now fully exposed as part of the [`importlib`](../library/importlib.md#module-importlib "importlib: The implementation of the import machinery.") package.

The abstract base classes defined in [`importlib.abc`](../library/importlib.md#module-importlib.abc "importlib.abc: Abstract base classes related to import") have been expanded to properly delineate between [meta path finders](../glossary.md#term-meta-path-finder) and [path entry finders](../glossary.md#term-path-entry-finder) by introducing [`importlib.abc.MetaPathFinder`](../library/importlib.md#importlib.abc.MetaPathFinder "importlib.abc.MetaPathFinder") and [`importlib.abc.PathEntryFinder`](../library/importlib.md#importlib.abc.PathEntryFinder "importlib.abc.PathEntryFinder"), respectively. The old ABC of `importlib.abc.Finder` is now only provided for backwards-compatibility and does not enforce any method requirements.

In terms of finders, [`importlib.machinery.FileFinder`](../library/importlib.md#importlib.machinery.FileFinder "importlib.machinery.FileFinder") exposes the mechanism used to search for source and bytecode files of a module. Previously this class was an implicit member of [`sys.path_hooks`](../library/sys.md#sys.path_hooks "sys.path_hooks").

For loaders, the new abstract base class [`importlib.abc.FileLoader`](../library/importlib.md#importlib.abc.FileLoader "importlib.abc.FileLoader") helps write a loader that uses the file system as the storage mechanism for a module's code. The loader for source files ([`importlib.machinery.SourceFileLoader`](../library/importlib.md#importlib.machinery.SourceFileLoader "importlib.machinery.SourceFileLoader")), sourceless bytecode files ([`importlib.machinery.SourcelessFileLoader`](../library/importlib.md#importlib.machinery.SourcelessFileLoader "importlib.machinery.SourcelessFileLoader")), and extension modules ([`importlib.machinery.ExtensionFileLoader`](../library/importlib.md#importlib.machinery.ExtensionFileLoader "importlib.machinery.ExtensionFileLoader")) are now available for direct use.

[`ImportError`](../library/exceptions.md#ImportError "ImportError") now has `name` and `path` attributes which are set when there is relevant data to provide. The message for failed imports will also provide the full name of the module now instead of just the tail end of the module's name.

The [`importlib.invalidate_caches()`](../library/importlib.md#importlib.invalidate_caches "importlib.invalidate_caches") function will now call the method with the same name on all finders cached in [`sys.path_importer_cache`](../library/sys.md#sys.path_importer_cache "sys.path_importer_cache") to help clean up any stored state as necessary.

### 可见的改变¶

For potential required changes to code, see the Porting Python code section.

Beyond the expanse of what [`importlib`](../library/importlib.md#module-importlib "importlib: The implementation of the import machinery.") now exposes, there are other visible changes to import. The biggest is that [`sys.meta_path`](../library/sys.md#sys.meta_path "sys.meta_path") and [`sys.path_hooks`](../library/sys.md#sys.path_hooks "sys.path_hooks") now store all of the meta path finders and path entry hooks used by import. Previously the finders were implicit and hidden within the C code of import instead of being directly exposed. This means that one can now easily remove or change the order of the various finders to fit one's needs.

Another change is that all modules have a `__loader__` attribute, storing the loader used to create the module. [**PEP 302**](https://peps.python.org/pep-0302/) has been updated to make this attribute mandatory for loaders to implement, so in the future once 3rd-party loaders have been updated people will be able to rely on the existence of the attribute. Until such time, though, import is setting the module post-load.

Loaders are also now expected to set the `__package__` attribute from [**PEP 366**](https://peps.python.org/pep-0366/). Once again, import itself is already setting this on all loaders from [`importlib`](../library/importlib.md#module-importlib "importlib: The implementation of the import machinery.") and import itself is setting the attribute post-load.

`None` is now inserted into [`sys.path_importer_cache`](../library/sys.md#sys.path_importer_cache "sys.path_importer_cache") when no finder can be found on [`sys.path_hooks`](../library/sys.md#sys.path_hooks "sys.path_hooks"). Since `imp.NullImporter` is not directly exposed on [`sys.path_hooks`](../library/sys.md#sys.path_hooks "sys.path_hooks") it could no longer be relied upon to always be available to use as a value representing no finder found.

All other changes relate to semantic changes which should be taken into consideration when updating code for Python 3.3, and thus should be read about in the Porting Python code section of this document.

（由 Brett Cannon 编写的实现）

## 其他语言特性修改¶

对Python 语言核心进行的小改动：

  * Added support for Unicode name aliases and named sequences. Both [`unicodedata.lookup()`](../library/unicodedata.md#unicodedata.lookup "unicodedata.lookup") and `'\N{...}'` now resolve name aliases, and [`unicodedata.lookup()`](../library/unicodedata.md#unicodedata.lookup "unicodedata.lookup") resolves named sequences too.

（由 Ezio Melotti 在 [bpo-12753](https://bugs.python.org/issue?@action=redirect&bpo=12753) 中贡献。）

  * Unicode 数据库更新至 UCD 版本 6.1.0

  * Equality comparisons on [`range()`](../library/stdtypes.md#range "range") objects now return a result reflecting the equality of the underlying sequences generated by those range objects. ([bpo-13201](https://bugs.python.org/issue?@action=redirect&bpo=13201))

  * The `count()`, `find()`, `rfind()`, `index()` and `rindex()` methods of [`bytes`](../library/stdtypes.md#bytes "bytes") and [`bytearray`](../library/stdtypes.md#bytearray "bytearray") objects now accept an integer between 0 and 255 as their first argument.

（由 Petri Lehtinen 在 [bpo-12170](https://bugs.python.org/issue?@action=redirect&bpo=12170) 中贡献。）

  * The `rjust()`, `ljust()`, and `center()` methods of [`bytes`](../library/stdtypes.md#bytes "bytes") and [`bytearray`](../library/stdtypes.md#bytearray "bytearray") now accept a [`bytearray`](../library/stdtypes.md#bytearray "bytearray") for the `fill` argument. (Contributed by Petri Lehtinen in [bpo-12380](https://bugs.python.org/issue?@action=redirect&bpo=12380).)

  * New methods have been added to [`list`](../library/stdtypes.md#list "list") and [`bytearray`](../library/stdtypes.md#bytearray "bytearray"): `copy()` and `clear()` ([bpo-10516](https://bugs.python.org/issue?@action=redirect&bpo=10516)). Consequently, [`MutableSequence`](../library/collections.abc.md#collections.abc.MutableSequence "collections.abc.MutableSequence") now also defines a `clear()` method ([bpo-11388](https://bugs.python.org/issue?@action=redirect&bpo=11388)).

  * Raw bytes literals can now be written `rb"..."` as well as `br"..."`.

（由 Antoine Pitrou 在 [bpo-13748](https://bugs.python.org/issue?@action=redirect&bpo=13748) 中贡献。）

  * [`dict.setdefault()`](../library/stdtypes.md#dict.setdefault "dict.setdefault") now does only one lookup for the given key, making it atomic when used with built-in types.

（由 Filip Gruszczyński 在 [bpo-13521](https://bugs.python.org/issue?@action=redirect&bpo=13521) 中贡献。）

  * The error messages produced when a function call does not match the function signature have been significantly improved.

（由 Benjamin Peterson 贡献。）

## A Finer-Grained Import Lock¶

Previous versions of CPython have always relied on a global import lock. This led to unexpected annoyances, such as deadlocks when importing a module would trigger code execution in a different thread as a side-effect. Clumsy workarounds were sometimes employed, such as the [`PyImport_ImportModuleNoBlock()`](../c-api/import.md#c.PyImport_ImportModuleNoBlock "PyImport_ImportModuleNoBlock") C API function.

In Python 3.3, importing a module takes a per-module lock. This correctly serializes importation of a given module from multiple threads (preventing the exposure of incompletely initialized modules), while eliminating the aforementioned annoyances.

（由 Antoine Pitrou 在 [bpo-9260](https://bugs.python.org/issue?@action=redirect&bpo=9260) 中贡献。）

## Builtin functions and types¶

  * [`open()`](../library/functions.md#open "open") gets a new _opener_ parameter: the underlying file descriptor for the file object is then obtained by calling _opener_ with ( _file_ , _flags_ ). It can be used to use custom flags like [`os.O_CLOEXEC`](../library/os.md#os.O_CLOEXEC "os.O_CLOEXEC") for example. The `'x'` mode was added: open for exclusive creation, failing if the file already exists.

  * [`print()`](../library/functions.md#print "print"): added the _flush_ keyword argument. If the _flush_ keyword argument is true, the stream is forcibly flushed.

  * [`hash()`](../library/functions.md#hash "hash"): hash randomization is enabled by default, see [`object.__hash__()`](../reference/datamodel.md#object.__hash__ "object.__hash__") and [`PYTHONHASHSEED`](../using/cmdline.md#envvar-PYTHONHASHSEED).

  * The [`str`](../library/stdtypes.md#str "str") type gets a new [`casefold()`](../library/stdtypes.md#str.casefold "str.casefold") method: return a casefolded copy of the string, casefolded strings may be used for caseless matching. For example, `'ß'.casefold()` returns `'ss'`.

  * The sequence documentation has been substantially rewritten to better explain the binary/text sequence distinction and to provide specific documentation sections for the individual builtin sequence types ([bpo-4966](https://bugs.python.org/issue?@action=redirect&bpo=4966)).

## 新增模块¶

### faulthandler¶

This new debug module [`faulthandler`](../library/faulthandler.md#module-faulthandler "faulthandler: Dump the Python traceback.") contains functions to dump Python tracebacks explicitly, on a fault (a crash like a segmentation fault), after a timeout, or on a user signal. Call [`faulthandler.enable()`](../library/faulthandler.md#faulthandler.enable "faulthandler.enable") to install fault handlers for the `SIGSEGV`, `SIGFPE`, `SIGABRT`, `SIGBUS`, and `SIGILL` signals. You can also enable them at startup by setting the [`PYTHONFAULTHANDLER`](../using/cmdline.md#envvar-PYTHONFAULTHANDLER) environment variable or by using [`-X`](../using/cmdline.md#cmdoption-X) `faulthandler` command line option.

Linux 上的段错误示例:
~~~
    
    
~~~
$ python -q -X faulthandler
>>> import ctypes
>>> ctypes.string_at(0)
Fatal Python error: Segmentation fault

Current thread 0x00007fb899f39700:
  File "/home/python/cpython/Lib/ctypes/__init__.py", line 486 in string_at
  File "<stdin>", line 1 in <module>
Segmentation fault
~~~

### ipaddress¶

The new [`ipaddress`](3.标准库/ipaddress.md#module-ipaddress "ipaddress: IPv4/IPv6 manipulation library.") module provides tools for creating and manipulating objects representing IPv4 and IPv6 addresses, networks and interfaces (i.e. an IP address associated with a specific IP subnet).

（由 Google 和 Peter Moody 在 [bpo-3144](https://bugs.python.org/issue?@action=redirect&bpo=3144) 中贡献。）

### lzma¶

The newly added [`lzma`](lzma.md#module-lzma "lzma: A Python wrapper for the liblzma compression library.") module provides data compression and decompression using the LZMA algorithm, including support for the `.xz` and `.lzma` file formats.

（由 Nadeem Vawda 和 Per Øyvind Karlsen 在 [bpo-6715](https://bugs.python.org/issue?@action=redirect&bpo=6715) 中贡献。）

## 改进的模块¶

### abc¶

Improved support for abstract base classes containing descriptors composed with abstract methods. The recommended approach to declaring abstract descriptors is now to provide `__isabstractmethod__` as a dynamically updated property. The built-in descriptors have been updated accordingly.

>   * [`abc.abstractproperty`](abc.md#abc.abstractproperty "abc.abstractproperty") has been deprecated, use [`property`](functions.md#property "property") with [`abc.abstractmethod()`](abc.md#abc.abstractmethod "abc.abstractmethod") instead.
>
>   * [`abc.abstractclassmethod`](abc.md#abc.abstractclassmethod "abc.abstractclassmethod") has been deprecated, use [`classmethod`](functions.md#classmethod "classmethod") with [`abc.abstractmethod()`](abc.md#abc.abstractmethod "abc.abstractmethod") instead.
>
>   * [`abc.abstractstaticmethod`](abc.md#abc.abstractstaticmethod "abc.abstractstaticmethod") has been deprecated, use [`staticmethod`](functions.md#staticmethod "staticmethod") with [`abc.abstractmethod()`](abc.md#abc.abstractmethod "abc.abstractmethod") instead.
>
>

（由 Pablo Galindo 在 [bpo-11610](https://bugs.python.org/issue?@action=redirect&bpo=11610) 中贡献。）

[`abc.ABCMeta.register()`](abc.md#abc.ABCMeta.register "abc.ABCMeta.register") now returns the registered subclass, which means it can now be used as a class decorator ([bpo-10868](https://bugs.python.org/issue?@action=redirect&bpo=10868)).

### array¶

The [`array`](array.md#module-array "array: Space efficient arrays of uniformly typed numeric values.") module supports the long long type using `q` and `Q` type codes.

（由 Oren Tirosh 和 Hirokazu Yamamoto 在 [bpo-1172711](https://bugs.python.org/issue?@action=redirect&bpo=1172711) 中贡献。）

### base64¶

ASCII-only Unicode strings are now accepted by the decoding functions of the [`base64`](base64.md#module-base64 "base64: RFC 4648: Base16, Base32, Base64 Data Encodings; Base85 and Ascii85") modern interface. For example, `base64.b64decode('YWJj')` returns `b'abc'`. (Contributed by Catalin Iacob in [bpo-13641](https://bugs.python.org/issue?@action=redirect&bpo=13641).)

### binascii¶

In addition to the binary objects they normally accept, the `a2b_` functions now all also accept ASCII-only strings as input. (Contributed by Antoine Pitrou in [bpo-13637](https://bugs.python.org/issue?@action=redirect&bpo=13637).)

### bz2¶

[`bz2`](bz2.md#module-bz2 "bz2: Interfaces for bzip2 compression and decompression.") 模块已被重新编写。 在此过程中，添加了一些新的特征:

  * 新的 [`bz2.open()`](bz2.md#bz2.open "bz2.open") 函数：以二进制或文本模式打开 bzip2 压缩文件。

  * [`bz2.BZ2File`](bz2.md#bz2.BZ2File "bz2.BZ2File") 现在可以读写任意文件类对象，具体方式是通过其构造器的 _fileobj_ 参数。

（由 Nadeem Vawda 在 [bpo-5863](https://bugs.python.org/issue?@action=redirect&bpo=5863) 中贡献。）

  * [`bz2.BZ2File`](bz2.md#bz2.BZ2File "bz2.BZ2File") and [`bz2.decompress()`](bz2.md#bz2.decompress "bz2.decompress") can now decompress multi-stream inputs (such as those produced by the **pbzip2** tool). [`bz2.BZ2File`](bz2.md#bz2.BZ2File "bz2.BZ2File") can now also be used to create this type of file, using the `'a'` (append) mode.

（由 Nir Aides 在 [bpo-1625](https://bugs.python.org/issue?@action=redirect&bpo=1625) 中贡献。）

  * [`bz2.BZ2File`](bz2.md#bz2.BZ2File "bz2.BZ2File") now implements all of the [`io.BufferedIOBase`](io.md#io.BufferedIOBase "io.BufferedIOBase") API, except for the `detach()` and `truncate()` methods.

### 编码器¶

The [`mbcs`](codecs.md#module-encodings.mbcs "encodings.mbcs: Windows ANSI codepage") codec has been rewritten to handle correctly `replace` and `ignore` error handlers on all Windows versions. The [`mbcs`](codecs.md#module-encodings.mbcs "encodings.mbcs: Windows ANSI codepage") codec now supports all error handlers, instead of only `replace` to encode and `ignore` to decode.

A new Windows-only codec has been added: `cp65001` ([bpo-13216](https://bugs.python.org/issue?@action=redirect&bpo=13216)). It is the Windows code page 65001 (Windows UTF-8, `CP_UTF8`). For example, it is used by `sys.stdout` if the console output code page is set to cp65001 (e.g., using `chcp 65001` command).

Multibyte CJK decoders now resynchronize faster. They only ignore the first byte of an invalid byte sequence. For example, `b'\xff\n'.decode('gb2312', 'replace')` now returns a `\n` after the replacement character.

([bpo-12016](https://bugs.python.org/issue?@action=redirect&bpo=12016))

Incremental CJK codec encoders are no longer reset at each call to their encode() methods. For example:

    
    
~~~shell
>>> import codecs
>>> encoder = codecs.getincrementalencoder('hz')('strict')
>>> b''.join(encoder.encode(x) for x in '\u52ff\u65bd\u65bc\u4eba\u3002 Bye.')
b'~{NpJ)l6HK!#~} Bye.'
~~~

This example gives `b'~{Np~}~{J)~}~{l6~}~{HK~}~{!#~} Bye.'` with older Python versions.

([bpo-12100](https://bugs.python.org/issue?@action=redirect&bpo=12100))

`unicode_internal` 编解码器已被弃用。

### collections¶

Addition of a new [`ChainMap`](collections.md#collections.ChainMap "collections.ChainMap") class to allow treating a number of mappings as a single unit. (Written by Raymond Hettinger for [bpo-11089](https://bugs.python.org/issue?@action=redirect&bpo=11089), made public in [bpo-11297](https://bugs.python.org/issue?@action=redirect&bpo=11297).)

The abstract base classes have been moved in a new [`collections.abc`](collections.abc.md#module-collections.abc "collections.abc: Abstract base classes for containers") module, to better differentiate between the abstract and the concrete collections classes. Aliases for ABCs are still present in the [`collections`](collections.md#module-collections "collections: Container datatypes") module to preserve existing imports. ([bpo-11085](https://bugs.python.org/issue?@action=redirect&bpo=11085))

The [`Counter`](collections.md#collections.Counter "collections.Counter") class now supports the unary `+` and `-` operators, as well as the in-place operators `+=`, `-=`, `|=`, and `&=`. (Contributed by Raymond Hettinger in [bpo-13121](https://bugs.python.org/issue?@action=redirect&bpo=13121).)

### contextlib¶

[`ExitStack`](contextlib.md#contextlib.ExitStack "contextlib.ExitStack") now provides a solid foundation for programmatic manipulation of context managers and similar cleanup functionality. Unlike the previous `contextlib.nested` API (which was deprecated and removed), the new API is designed to work correctly regardless of whether context managers acquire their resources in their `__init__` method (for example, file objects) or in their `__enter__` method (for example, synchronisation objects from the [`threading`](threading.md#module-threading "threading: Thread-based parallelism.") module).

([bpo-13585](https://bugs.python.org/issue?@action=redirect&bpo=13585))

### crypt¶

Addition of salt and modular crypt format (hashing method) and the `mksalt()` function to the `crypt` module.

([bpo-10924](https://bugs.python.org/issue?@action=redirect&bpo=10924))

### curses¶

>   * If the [`curses`](3.标准库/curses.md#module-curses "curses: An interface to the curses library, providing portable terminal handling. \(Unix\)") module is linked to the ncursesw library, use Unicode functions when Unicode strings or characters are passed (e.g. `waddwstr()`), and bytes functions otherwise (e.g. `waddstr()`).
>
>   * Use the locale encoding instead of `utf-8` to encode Unicode strings.
>
>   * `curses.window` 添加了新的 [`curses.window.encoding`](3.标准库/curses.md#curses.window.encoding "curses.window.encoding") 属性。
>
>   * `curses.window` 类有一个新的 [`get_wch()`](3.标准库/curses.md#curses.window.get_wch "curses.window.get_wch") 方法用来获取一个宽字符。
>
>   * [`curses`](3.标准库/curses.md#module-curses "curses: An interface to the curses library, providing portable terminal handling. \(Unix\)") 模块有一个新的 [`unget_wch()`](3.标准库/curses.md#curses.unget_wch "curses.unget_wch") 函数用来推入一个宽字符以便下一个 [`get_wch()`](3.标准库/curses.md#curses.window.get_wch "curses.window.get_wch") 将返回它。
>
>

（由 Iñigo Serna 在 [bpo-6755](https://bugs.python.org/issue?@action=redirect&bpo=6755) 中贡献。）

### datetime¶

>   * Equality comparisons between naive and aware [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime") instances now return [`False`](constants.md#False "False") instead of raising [`TypeError`](3.标准库/exceptions.md#TypeError "TypeError") ([bpo-15006](https://bugs.python.org/issue?@action=redirect&bpo=15006)).
>
>   * New [`datetime.datetime.timestamp()`](3.标准库/datetime.md#datetime.datetime.timestamp "datetime.datetime.timestamp") method: Return POSIX timestamp corresponding to the [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime") instance.
>
>   * The [`datetime.datetime.strftime()`](3.标准库/datetime.md#datetime.datetime.strftime "datetime.datetime.strftime") method supports formatting years older than 1000.
>
>   * The [`datetime.datetime.astimezone()`](3.标准库/datetime.md#datetime.datetime.astimezone "datetime.datetime.astimezone") method can now be called without arguments to convert datetime instance to the system timezone.
>
>

### decimal¶

[bpo-7652](https://bugs.python.org/issue?@action=redirect&bpo=7652) \- integrate fast native decimal arithmetic.

    

~~~
C-module and libmpdec written by Stefan Krah.

The new C version of the decimal module integrates the high speed libmpdec library for arbitrary precision correctly rounded decimal floating point arithmetic. libmpdec conforms to IBM's General Decimal Arithmetic Specification.

Performance gains range from 10x for database applications to 100x for numerically intensive applications. These numbers are expected gains for standard precisions used in decimal floating point arithmetic. Since the precision is user configurable, the exact figures may vary. For example, in integer bignum arithmetic the differences can be significantly higher.

The following table is meant as an illustration. Benchmarks are available at <https://www.bytereef.org/mpdecimal/quickstart.md>.

> |
>
> decimal.py
>
> |
>
> _decimal
>
> |
>
> 加速  
>  
> ---|---|---|---  
>  
> pi
>
> |
>
> 42.02秒
>
> |
>
> 0.345秒
>
> |
>
> 120倍  
>  
> telco
>
> |
>
> 172.19秒
>
> |
>
> 5.68秒
>
> |
>
> 30倍  
>  
> psycopg
>
> |
>
> 3.57秒
>
> |
>
> 0.29秒
>
> |
>
> 12倍  
  
#### 相关特性¶

  * The [`FloatOperation`](../library/decimal.md#decimal.FloatOperation "decimal.FloatOperation") signal optionally enables stricter semantics for mixing floats and Decimals.

  * If Python is compiled without threads, the C version automatically disables the expensive thread local context machinery. In this case, the variable [`HAVE_THREADS`](../library/decimal.md#decimal.HAVE_THREADS "decimal.HAVE_THREADS") is set to `False`.

#### API 的变化¶

  * C模块上下文限制（如下表），具体取决于计算机体系结构：

> |
>
> 32位
>
> |
>
> 64位  
>  
> ---|---|---  
>  
> `MAX_PREC`
>
> |
>
> `425000000`
>
> |
>
> `999999999999999999`  
>  
> `MAX_EMAX`
>
> |
>
> `425000000`
>
> |
>
> `999999999999999999`  
>  
> `MIN_EMIN`
>
> |
>
> `-425000000`
>
> |
>
> `-999999999999999999`  
  
  * In the context templates ([`DefaultContext`](../library/decimal.md#decimal.DefaultContext "decimal.DefaultContext"), [`BasicContext`](../library/decimal.md#decimal.BasicContext "decimal.BasicContext") and [`ExtendedContext`](../library/decimal.md#decimal.ExtendedContext "decimal.ExtendedContext")) the magnitude of `Emax` and `Emin` has changed to `999999`.

  * The [`Decimal`](../library/decimal.md#decimal.Decimal "decimal.Decimal") constructor in decimal.py does not observe the context limits and converts values with arbitrary exponents or precision exactly. Since the C version has internal limits, the following scheme is used: If possible, values are converted exactly, otherwise [`InvalidOperation`](../library/decimal.md#decimal.InvalidOperation "decimal.InvalidOperation") is raised and the result is NaN. In the latter case it is always possible to use [`create_decimal()`](../library/decimal.md#decimal.Context.create_decimal "decimal.Context.create_decimal") in order to obtain a rounded or inexact value.

  * The power function in decimal.py is always correctly rounded. In the C version, it is defined in terms of the correctly rounded [`exp()`](../library/decimal.md#decimal.Decimal.exp "decimal.Decimal.exp") and [`ln()`](../library/decimal.md#decimal.Decimal.ln "decimal.Decimal.ln") functions, but the final result is only "almost always correctly rounded".

  * In the C version, the context dictionary containing the signals is a [`MutableMapping`](../library/collections.abc.md#collections.abc.MutableMapping "collections.abc.MutableMapping"). For speed reasons, `flags` and `traps` always refer to the same [`MutableMapping`](../library/collections.abc.md#collections.abc.MutableMapping "collections.abc.MutableMapping") that the context was initialized with. If a new signal dictionary is assigned, `flags` and `traps` are updated with the new values, but they do not reference the RHS dictionary.

  * Pickling a [`Context`](../library/decimal.md#decimal.Context "decimal.Context") produces a different output in order to have a common interchange format for the Python and C versions.

  * The order of arguments in the [`Context`](../library/decimal.md#decimal.Context "decimal.Context") constructor has been changed to match the order displayed by [`repr()`](../library/functions.md#repr "repr").

  * The `watchexp` parameter in the [`quantize()`](../library/decimal.md#decimal.Decimal.quantize "decimal.Decimal.quantize") method is deprecated.

### email¶

#### Policy Framework¶

The email package now has a [`policy`](../library/email.policy.md#module-email.policy "email.policy: Controlling the parsing and generating of messages") framework. A [`Policy`](../library/email.policy.md#email.policy.Policy "email.policy.Policy") is an object with several methods and properties that control how the email package behaves. The primary policy for Python 3.3 is the [`Compat32`](../library/email.policy.md#email.policy.Compat32 "email.policy.Compat32") policy, which provides backward compatibility with the email package in Python 3.2. A `policy` can be specified when an email message is parsed by a [`parser`](../library/email.parser.md#module-email.parser "email.parser: Parse flat text email messages to produce a message object structure."), or when a [`Message`](../library/email.compat32-message.md#email.message.Message "email.message.Message") object is created, or when an email is serialized using a [`generator`](../library/email.generator.md#module-email.generator "email.generator: Generate flat text email messages from a message structure."). Unless overridden, a policy passed to a `parser` is inherited by all the `Message` object and sub-objects created by the `parser`. By default a `generator` will use the policy of the `Message` object it is serializing. The default policy is [`compat32`](../library/email.policy.md#email.policy.compat32 "email.policy.compat32").

The minimum set of controls implemented by all `policy` objects are:

> max_line_length
>
> |
>
> The maximum length, excluding the linesep character(s), individual lines may have when a `Message` is serialized. Defaults to 78.  
>  
> ---|---  
>  
> linesep
>
> |
>
> The character used to separate individual lines when a `Message` is serialized. Defaults to `\n`.  
>  
> cte_type
>
> |
>
> `7bit` or `8bit`. `8bit` applies only to a `Bytes` `generator`, and means that non-ASCII may be used where allowed by the protocol (or where it exists in the original input).  
>  
> raise_on_defect
>
> |
>
> 导致一个 `parser` 在遇到缺陷时引发错误而不是将它们添加到 `Message` 对象的 `defects` 列表。  
  
A new policy instance, with new settings, is created using the [`clone()`](../library/email.policy.md#email.policy.Policy.clone "email.policy.Policy.clone") method of policy objects. `clone` takes any of the above controls as keyword arguments. Any control not specified in the call retains its default value. Thus you can create a policy that uses `\r\n` linesep characters like this:
~~~
    
    
~~~
mypolicy = compat32.clone(linesep='\r\n')
~~~

Policies can be used to make the generation of messages in the format needed by your application simpler. Instead of having to remember to specify `linesep='\r\n'` in all the places you call a `generator`, you can specify it once, when you set the policy used by the `parser` or the `Message`, whichever your program uses to create `Message` objects. On the other hand, if you need to generate messages in multiple forms, you can still specify the parameters in the appropriate `generator` call. Or you can have custom policy instances for your different cases, and pass those in when you create the `generator`.

#### Provisional Policy with New Header API¶

While the policy framework is worthwhile all by itself, the main motivation for introducing it is to allow the creation of new policies that implement new features for the email package in a way that maintains backward compatibility for those who do not use the new policies. Because the new policies introduce a new API, we are releasing them in Python 3.3 as a [provisional policy](../glossary.md#term-provisional-package). Backwards incompatible changes (up to and including removal of the code) may occur if deemed necessary by the core developers.

The new policies are instances of [`EmailPolicy`](email.policy.md#email.policy.EmailPolicy "email.policy.EmailPolicy"), and add the following additional controls:

> refold_source
>
> |
>
> Controls whether or not headers parsed by a [`parser`](email.parser.md#module-email.parser "email.parser: Parse flat text email messages to produce a message object structure.") are refolded by the [`generator`](email.generator.md#module-email.generator "email.generator: Generate flat text email messages from a message structure."). It can be `none`, `long`, or `all`. The default is `long`, which means that source headers with a line longer than `max_line_length` get refolded. `none` means no line get refolded, and `all` means that all lines get refolded.  
>  
> ---|---  
>  
> header_factory
>
> |
>
> A callable that take a `name` and `value` and produces a custom header object.  
  
The `header_factory` is the key to the new features provided by the new policies. When one of the new policies is used, any header retrieved from a `Message` object is an object produced by the `header_factory`, and any time you set a header on a `Message` it becomes an object produced by `header_factory`. All such header objects have a `name` attribute equal to the header name. Address and Date headers have additional attributes that give you access to the parsed data of the header. This means you can now do things like this:

    
    
~~~shell
>>> m = Message(policy=SMTP)
>>> m['To'] = 'Éric <foo@example.com>'
>>> m['to']
'Éric <foo@example.com>'
>>> m['to'].addresses
(Address(display_name='Éric', username='foo', domain='example.com'),)
>>> m['to'].addresses[0].username
'foo'
>>> m['to'].addresses[0].display_name
'Éric'
>>> m['Date'] = email.utils.localtime()
>>> m['Date'].datetime
datetime.datetime(2012, 5, 25, 21, 39, 24, 465484, tzinfo=datetime.timezone(datetime.timedelta(-1, 72000), 'EDT'))
>>> m['Date']
'Fri, 25 May 2012 21:44:27 -0400'
>>> print(m)
To: =?utf-8?q?=C3=89ric?= <foo@example.com>
Date: Fri, 25 May 2012 21:44:27 -0400
~~~

You will note that the unicode display name is automatically encoded as `utf-8` when the message is serialized, but that when the header is accessed directly, you get the unicode version. This eliminates any need to deal with the [`email.header`](email.header.md#module-email.header "email.header: Representing non-ASCII headers") [`decode_header()`](email.header.md#email.header.decode_header "email.header.decode_header") or [`make_header()`](email.header.md#email.header.make_header "email.header.make_header") functions.

You can also create addresses from parts:

    
    
~~~shell
>>> m['cc'] = [Group('pals', [Address('Bob', 'bob', 'example.com'),
...                           Address('Sally', 'sally', 'example.com')]),
...            Address('Bonzo', addr_spec='bonz@laugh.com')]
>>> print(m)
To: =?utf-8?q?=C3=89ric?= <foo@example.com>
Date: Fri, 25 May 2012 21:44:27 -0400
cc: pals: Bob <bob@example.com>, Sally <sally@example.com>;, Bonzo <bonz@laugh.com>
~~~

Decoding to unicode is done automatically:

    
    
~~~shell
>>> m2 = message_from_string(str(m))
>>> m2['to']
'Éric <foo@example.com>'
~~~

When you parse a message, you can use the `addresses` and `groups` attributes of the header objects to access the groups and individual addresses:

    
    
~~~shell
>>> m2['cc'].addresses
(Address(display_name='Bob', username='bob', domain='example.com'), Address(display_name='Sally', username='sally', domain='example.com'), Address(display_name='Bonzo', username='bonz', domain='laugh.com'))
>>> m2['cc'].groups
(Group(display_name='pals', addresses=(Address(display_name='Bob', username='bob', domain='example.com'), Address(display_name='Sally', username='sally', domain='example.com')), Group(display_name=None, addresses=(Address(display_name='Bonzo', username='bonz', domain='laugh.com'),))
~~~

In summary, if you use one of the new policies, header manipulation works the way it ought to: your application works with unicode strings, and the email package transparently encodes and decodes the unicode to and from the RFC standard Content Transfer Encodings.

#### Other API Changes¶

New [`BytesHeaderParser`](email.parser.md#email.parser.BytesHeaderParser "email.parser.BytesHeaderParser"), added to the [`parser`](email.parser.md#module-email.parser "email.parser: Parse flat text email messages to produce a message object structure.") module to complement [`HeaderParser`](email.parser.md#email.parser.HeaderParser "email.parser.HeaderParser") and complete the Bytes API.

New utility functions:

>   * [`format_datetime()`](email.utils.md#email.utils.format_datetime "email.utils.format_datetime"): given a [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime"), produce a string formatted for use in an email header.
>
>   * [`parsedate_to_datetime()`](email.utils.md#email.utils.parsedate_to_datetime "email.utils.parsedate_to_datetime"): given a date string from an email header, convert it into an aware [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime"), or a naive [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime") if the offset is `-0000`.
>
>   * [`localtime()`](email.utils.md#email.utils.localtime "email.utils.localtime"): With no argument, returns the current local time as an aware [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime") using the local [`timezone`](3.标准库/datetime.md#datetime.timezone "datetime.timezone"). Given an aware [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime"), converts it into an aware [`datetime`](3.标准库/datetime.md#datetime.datetime "datetime.datetime") using the local [`timezone`](3.标准库/datetime.md#datetime.timezone "datetime.timezone").
>
>

### ftplib¶

  * [`ftplib.FTP`](ftplib.md#ftplib.FTP "ftplib.FTP") now accepts a `source_address` keyword argument to specify the `(host, port)` to use as the source address in the bind call when creating the outgoing socket. (Contributed by Giampaolo Rodolà in [bpo-8594](https://bugs.python.org/issue?@action=redirect&bpo=8594).)

  * The `FTP_TLS` class now provides a new [`ccc()`](ftplib.md#ftplib.FTP_TLS.ccc "ftplib.FTP_TLS.ccc") function to revert control channel back to plaintext. This can be useful to take advantage of firewalls that know how to handle NAT with non-secure FTP without opening fixed ports. (Contributed by Giampaolo Rodolà in [bpo-12139](https://bugs.python.org/issue?@action=redirect&bpo=12139).)

  * Added [`ftplib.FTP.mlsd()`](ftplib.md#ftplib.FTP.mlsd "ftplib.FTP.mlsd") method which provides a parsable directory listing format and deprecates [`ftplib.FTP.nlst()`](ftplib.md#ftplib.FTP.nlst "ftplib.FTP.nlst") and [`ftplib.FTP.dir()`](ftplib.md#ftplib.FTP.dir "ftplib.FTP.dir"). (Contributed by Giampaolo Rodolà in [bpo-11072](https://bugs.python.org/issue?@action=redirect&bpo=11072).)

### functools¶

The [`functools.lru_cache()`](functools.md#functools.lru_cache "functools.lru_cache") decorator now accepts a `typed` keyword argument (that defaults to `False` to ensure that it caches values of different types that compare equal in separate cache slots. (Contributed by Raymond Hettinger in [bpo-13227](https://bugs.python.org/issue?@action=redirect&bpo=13227).)

### gc¶

It is now possible to register callbacks invoked by the garbage collector before and after collection using the new [`callbacks`](gc.md#gc.callbacks "gc.callbacks") list.

### hmac¶

A new [`compare_digest()`](hmac.md#hmac.compare_digest "hmac.compare_digest") function has been added to prevent side channel attacks on digests through timing analysis. (Contributed by Nick Coghlan and Christian Heimes in [bpo-15061](https://bugs.python.org/issue?@action=redirect&bpo=15061).)

### http¶

[`http.server.BaseHTTPRequestHandler`](http.server.md#http.server.BaseHTTPRequestHandler "http.server.BaseHTTPRequestHandler") now buffers the headers and writes them all at once when [`end_headers()`](http.server.md#http.server.BaseHTTPRequestHandler.end_headers "http.server.BaseHTTPRequestHandler.end_headers") is called. A new method [`flush_headers()`](http.server.md#http.server.BaseHTTPRequestHandler.flush_headers "http.server.BaseHTTPRequestHandler.flush_headers") can be used to directly manage when the accumulated headers are sent. (Contributed by Andrew Schaaf in [bpo-3709](https://bugs.python.org/issue?@action=redirect&bpo=3709).)

[`http.server`](http.server.md#module-http.server "http.server: HTTP server and request handlers.") now produces valid `HTML 4.01 strict` output. (Contributed by Ezio Melotti in [bpo-13295](https://bugs.python.org/issue?@action=redirect&bpo=13295).)

[`http.client.HTTPResponse`](http.client.md#http.client.HTTPResponse "http.client.HTTPResponse") now has a [`readinto()`](http.client.md#http.client.HTTPResponse.readinto "http.client.HTTPResponse.readinto") method, which means it can be used as an [`io.RawIOBase`](io.md#io.RawIOBase "io.RawIOBase") class. (Contributed by John Kuhn in [bpo-13464](https://bugs.python.org/issue?@action=redirect&bpo=13464).)

### html¶

[`html.parser.HTMLParser`](html.parser.md#html.parser.HTMLParser "html.parser.HTMLParser") is now able to parse broken markup without raising errors, therefore the _strict_ argument of the constructor and the `HTMLParseError` exception are now deprecated. The ability to parse broken markup is the result of a number of bug fixes that are also available on the latest bug fix releases of Python 2.7/3.2. (Contributed by Ezio Melotti in [bpo-15114](https://bugs.python.org/issue?@action=redirect&bpo=15114), and [bpo-14538](https://bugs.python.org/issue?@action=redirect&bpo=14538), [bpo-13993](https://bugs.python.org/issue?@action=redirect&bpo=13993), [bpo-13960](https://bugs.python.org/issue?@action=redirect&bpo=13960), [bpo-13358](https://bugs.python.org/issue?@action=redirect&bpo=13358), [bpo-1745761](https://bugs.python.org/issue?@action=redirect&bpo=1745761), [bpo-755670](https://bugs.python.org/issue?@action=redirect&bpo=755670), [bpo-13357](https://bugs.python.org/issue?@action=redirect&bpo=13357), [bpo-12629](https://bugs.python.org/issue?@action=redirect&bpo=12629), [bpo-1200313](https://bugs.python.org/issue?@action=redirect&bpo=1200313), [bpo-670664](https://bugs.python.org/issue?@action=redirect&bpo=670664), [bpo-13273](https://bugs.python.org/issue?@action=redirect&bpo=13273), [bpo-12888](https://bugs.python.org/issue?@action=redirect&bpo=12888), [bpo-7311](https://bugs.python.org/issue?@action=redirect&bpo=7311).)

A new [`html5`](html.entities.md#html.entities.md5 "html.entities.md5") dictionary that maps HTML5 named character references to the equivalent Unicode character(s) (e.g. `html5['gt;'] == '>'`) has been added to the [`html.entities`](html.entities.md#module-html.entities "html.entities: Definitions of HTML general entities.") module. The dictionary is now also used by [`HTMLParser`](html.parser.md#html.parser.HTMLParser "html.parser.HTMLParser"). (Contributed by Ezio Melotti in [bpo-11113](https://bugs.python.org/issue?@action=redirect&bpo=11113) and [bpo-15156](https://bugs.python.org/issue?@action=redirect&bpo=15156).)

### imaplib¶

The [`IMAP4_SSL`](imaplib.md#imaplib.IMAP4_SSL "imaplib.IMAP4_SSL") constructor now accepts an SSLContext parameter to control parameters of the secure channel.

（由 Sijin Joseph 在 [bpo-8808](https://bugs.python.org/issue?@action=redirect&bpo=8808) 中贡献。）

### inspect¶

A new [`getclosurevars()`](inspect.md#inspect.getclosurevars "inspect.getclosurevars") function has been added. This function reports the current binding of all names referenced from the function body and where those names were resolved, making it easier to verify correct internal state when testing code that relies on stateful closures.

（由 Meador Inge 和 Nick Coghlan 在 [bpo-13062](https://bugs.python.org/issue?@action=redirect&bpo=13062) 中贡献。）

A new [`getgeneratorlocals()`](inspect.md#inspect.getgeneratorlocals "inspect.getgeneratorlocals") function has been added. This function reports the current binding of local variables in the generator's stack frame, making it easier to verify correct internal state when testing generators.

（由 Meador Inge 在 [bpo-15153](https://bugs.python.org/issue?@action=redirect&bpo=15153) 中贡献。）

### io¶

The [`open()`](io.md#io.open "io.open") function has a new `'x'` mode that can be used to exclusively create a new file, and raise a [`FileExistsError`](3.标准库/exceptions.md#FileExistsError "FileExistsError") if the file already exists. It is based on the C11 'x' mode to fopen().

（由 David Townshend 在 [bpo-12760](https://bugs.python.org/issue?@action=redirect&bpo=12760) 中贡献。）

The constructor of the [`TextIOWrapper`](io.md#io.TextIOWrapper "io.TextIOWrapper") class has a new _write_through_ optional argument. If _write_through_ is `True`, calls to `write()` are guaranteed not to be buffered: any data written on the [`TextIOWrapper`](io.md#io.TextIOWrapper "io.TextIOWrapper") object is immediately handled to its underlying binary buffer.

### itertools¶

[`accumulate()`](itertools.md#itertools.accumulate "itertools.accumulate") now takes an optional `func` argument for providing a user-supplied binary function.

### logging¶

The [`basicConfig()`](3.标准库/logging.md#logging.basicConfig "logging.basicConfig") function now supports an optional `handlers` argument taking an iterable of handlers to be added to the root logger.

A class level attribute `append_nul` has been added to [`SysLogHandler`](logging.handlers.md#logging.handlers.SysLogHandler "logging.handlers.SysLogHandler") to allow control of the appending of the `NUL` (`\000`) byte to syslog records, since for some daemons it is required while for others it is passed through to the log.

### math¶

The [`math`](math.md#module-math "math: Mathematical functions \(sin\(\) etc.\).") module has a new function, [`log2()`](math.md#math.log2 "math.log2"), which returns the base-2 logarithm of _x_.

(Written by Mark Dickinson in [bpo-11888](https://bugs.python.org/issue?@action=redirect&bpo=11888).)

### mmap¶

The [`read()`](mmap.md#mmap.mmap.read "mmap.mmap.read") method is now more compatible with other file-like objects: if the argument is omitted or specified as `None`, it returns the bytes from the current file position to the end of the mapping. (Contributed by Petri Lehtinen in [bpo-12021](https://bugs.python.org/issue?@action=redirect&bpo=12021).)

### multiprocessing¶

The new [`multiprocessing.connection.wait()`](multiprocessing.md#multiprocessing.connection.wait "multiprocessing.connection.wait") function allows polling multiple objects (such as connections, sockets and pipes) with a timeout. (Contributed by Richard Oudkerk in [bpo-12328](https://bugs.python.org/issue?@action=redirect&bpo=12328).)

`multiprocessing.Connection` objects can now be transferred over multiprocessing connections. (Contributed by Richard Oudkerk in [bpo-4892](https://bugs.python.org/issue?@action=redirect&bpo=4892).)

[`multiprocessing.Process`](multiprocessing.md#multiprocessing.Process "multiprocessing.Process") now accepts a `daemon` keyword argument to override the default behavior of inheriting the `daemon` flag from the parent process ([bpo-6064](https://bugs.python.org/issue?@action=redirect&bpo=6064)).

New attribute [`multiprocessing.Process.sentinel`](multiprocessing.md#multiprocessing.Process.sentinel "multiprocessing.Process.sentinel") allows a program to wait on multiple [`Process`](multiprocessing.md#multiprocessing.Process "multiprocessing.Process") objects at one time using the appropriate OS primitives (for example, [`select`](select.md#module-select "select: Wait for I/O completion on multiple streams.") on posix systems).

New methods [`multiprocessing.pool.Pool.starmap()`](multiprocessing.md#multiprocessing.pool.Pool.starmap "multiprocessing.pool.Pool.starmap") and [`starmap_async()`](multiprocessing.md#multiprocessing.pool.Pool.starmap_async "multiprocessing.pool.Pool.starmap_async") provide [`itertools.starmap()`](itertools.md#itertools.starmap "itertools.starmap") equivalents to the existing [`multiprocessing.pool.Pool.map()`](multiprocessing.md#multiprocessing.pool.Pool.map "multiprocessing.pool.Pool.map") and [`map_async()`](multiprocessing.md#multiprocessing.pool.Pool.map_async "multiprocessing.pool.Pool.map_async") functions. (Contributed by Hynek Schlawack in [bpo-12708](https://bugs.python.org/issue?@action=redirect&bpo=12708).)

### nntplib¶

The `nntplib.NNTP` class now supports the context management protocol to unconditionally consume [`socket.error`](socket.md#socket.error "socket.error") exceptions and to close the NNTP connection when done:

    
    
~~~shell
>>> from nntplib import NNTP
>>> with NNTP('news.gmane.org') as n:
...     n.group('gmane.comp.python.committers')
...
('211 1755 1 1755 gmane.comp.python.committers', 1755, 1, 1755, 'gmane.comp.python.committers')
>>>
~~~

（由 Giampaolo Rodolà 在 [bpo-9795](https://bugs.python.org/issue?@action=redirect&bpo=9795) 中贡献。）

### os¶

  * The [`os`](os.md#module-os "os: Miscellaneous operating system interfaces.") module has a new [`pipe2()`](os.md#os.pipe2 "os.pipe2") function that makes it possible to create a pipe with [`O_CLOEXEC`](os.md#os.O_CLOEXEC "os.O_CLOEXEC") or [`O_NONBLOCK`](os.md#os.O_NONBLOCK "os.O_NONBLOCK") flags set atomically. This is especially useful to avoid race conditions in multi-threaded programs.

  * The [`os`](os.md#module-os "os: Miscellaneous operating system interfaces.") module has a new [`sendfile()`](os.md#os.sendfile "os.sendfile") function which provides an efficient "zero-copy" way for copying data from one file (or socket) descriptor to another. The phrase "zero-copy" refers to the fact that all of the copying of data between the two descriptors is done entirely by the kernel, with no copying of data into userspace buffers. [`sendfile()`](os.md#os.sendfile "os.sendfile") can be used to efficiently copy data from a file on disk to a network socket, e.g. for downloading a file.

(Patch submitted by Ross Lagerwall and Giampaolo Rodolà in [bpo-10882](https://bugs.python.org/issue?@action=redirect&bpo=10882).)

  * To avoid race conditions like symlink attacks and issues with temporary files and directories, it is more reliable (and also faster) to manipulate file descriptors instead of file names. Python 3.3 enhances existing functions and introduces new functions to work on file descriptors ([bpo-4761](https://bugs.python.org/issue?@action=redirect&bpo=4761), [bpo-10755](https://bugs.python.org/issue?@action=redirect&bpo=10755) and [bpo-14626](https://bugs.python.org/issue?@action=redirect&bpo=14626)).

    * The [`os`](os.md#module-os "os: Miscellaneous operating system interfaces.") module has a new [`fwalk()`](os.md#os.fwalk "os.fwalk") function similar to [`walk()`](os.md#os.walk "os.walk") except that it also yields file descriptors referring to the directories visited. This is especially useful to avoid symlink races.

    * The following functions get new optional _dir_fd_ ([paths relative to directory descriptors](os.md#dir-fd)) and/or _follow_symlinks_ ([not following symlinks](os.md#follow-symlinks)): [`access()`](os.md#os.access "os.access"), [`chflags()`](os.md#os.chflags "os.chflags"), [`chmod()`](os.md#os.chmod "os.chmod"), [`chown()`](os.md#os.chown "os.chown"), [`link()`](os.md#os.link "os.link"), [`lstat()`](os.md#os.lstat "os.lstat"), [`mkdir()`](os.md#os.mkdir "os.mkdir"), [`mkfifo()`](os.md#os.mkfifo "os.mkfifo"), [`mknod()`](os.md#os.mknod "os.mknod"), [`open()`](os.md#os.open "os.open"), [`readlink()`](os.md#os.readlink "os.readlink"), [`remove()`](os.md#os.remove "os.remove"), [`rename()`](os.md#os.rename "os.rename"), [`replace()`](os.md#os.replace "os.replace"), [`rmdir()`](os.md#os.rmdir "os.rmdir"), [`stat()`](os.md#os.stat "os.stat"), [`symlink()`](os.md#os.symlink "os.symlink"), [`unlink()`](os.md#os.unlink "os.unlink"), [`utime()`](os.md#os.utime "os.utime"). Platform support for using these parameters can be checked via the sets [`os.supports_dir_fd`](os.md#os.supports_dir_fd "os.supports_dir_fd") and `os.supports_follows_symlinks`.

    * The following functions now support a file descriptor for their path argument: [`chdir()`](os.md#os.chdir "os.chdir"), [`chmod()`](os.md#os.chmod "os.chmod"), [`chown()`](os.md#os.chown "os.chown"), [`execve()`](os.md#os.execve "os.execve"), [`listdir()`](os.md#os.listdir "os.listdir"), [`pathconf()`](os.md#os.pathconf "os.pathconf"), [`exists()`](os.path.md#os.path.exists "os.path.exists"), [`stat()`](os.md#os.stat "os.stat"), [`statvfs()`](os.md#os.statvfs "os.statvfs"), [`utime()`](os.md#os.utime "os.utime"). Platform support for this can be checked via the [`os.supports_fd`](os.md#os.supports_fd "os.supports_fd") set.

  * [`access()`](os.md#os.access "os.access") accepts an `effective_ids` keyword argument to turn on using the effective uid/gid rather than the real uid/gid in the access check. Platform support for this can be checked via the [`supports_effective_ids`](os.md#os.supports_effective_ids "os.supports_effective_ids") set.

  * The [`os`](os.md#module-os "os: Miscellaneous operating system interfaces.") module has two new functions: [`getpriority()`](os.md#os.getpriority "os.getpriority") and [`setpriority()`](os.md#os.setpriority "os.setpriority"). They can be used to get or set process niceness/priority in a fashion similar to [`os.nice()`](os.md#os.nice "os.nice") but extended to all processes instead of just the current one.

(Patch submitted by Giampaolo Rodolà in [bpo-10784](https://bugs.python.org/issue?@action=redirect&bpo=10784).)

  * The new [`os.replace()`](os.md#os.replace "os.replace") function allows cross-platform renaming of a file with overwriting the destination. With [`os.rename()`](os.md#os.rename "os.rename"), an existing destination file is overwritten under POSIX, but raises an error under Windows. (Contributed by Antoine Pitrou in [bpo-8828](https://bugs.python.org/issue?@action=redirect&bpo=8828).)

  * The stat family of functions ([`stat()`](os.md#os.stat "os.stat"), [`fstat()`](os.md#os.fstat "os.fstat"), and [`lstat()`](os.md#os.lstat "os.lstat")) now support reading a file's timestamps with nanosecond precision. Symmetrically, [`utime()`](os.md#os.utime "os.utime") can now write file timestamps with nanosecond precision. (Contributed by Larry Hastings in [bpo-14127](https://bugs.python.org/issue?@action=redirect&bpo=14127).)

  * The new [`os.get_terminal_size()`](os.md#os.get_terminal_size "os.get_terminal_size") function queries the size of the terminal attached to a file descriptor. See also [`shutil.get_terminal_size()`](shutil.md#shutil.get_terminal_size "shutil.get_terminal_size"). (Contributed by Zbigniew Jędrzejewski-Szmek in [bpo-13609](https://bugs.python.org/issue?@action=redirect&bpo=13609).)

  * New functions to support Linux extended attributes ([bpo-12720](https://bugs.python.org/issue?@action=redirect&bpo=12720)): [`getxattr()`](os.md#os.getxattr "os.getxattr"), [`listxattr()`](os.md#os.listxattr "os.listxattr"), [`removexattr()`](os.md#os.removexattr "os.removexattr"), [`setxattr()`](os.md#os.setxattr "os.setxattr").

  * New interface to the scheduler. These functions control how a process is allocated CPU time by the operating system. New functions: [`sched_get_priority_max()`](os.md#os.sched_get_priority_max "os.sched_get_priority_max"), [`sched_get_priority_min()`](os.md#os.sched_get_priority_min "os.sched_get_priority_min"), [`sched_getaffinity()`](os.md#os.sched_getaffinity "os.sched_getaffinity"), [`sched_getparam()`](os.md#os.sched_getparam "os.sched_getparam"), [`sched_getscheduler()`](os.md#os.sched_getscheduler "os.sched_getscheduler"), [`sched_rr_get_interval()`](os.md#os.sched_rr_get_interval "os.sched_rr_get_interval"), [`sched_setaffinity()`](os.md#os.sched_setaffinity "os.sched_setaffinity"), [`sched_setparam()`](os.md#os.sched_setparam "os.sched_setparam"), [`sched_setscheduler()`](os.md#os.sched_setscheduler "os.sched_setscheduler"), [`sched_yield()`](os.md#os.sched_yield "os.sched_yield"),

  * New functions to control the file system:

    * [`posix_fadvise()`](os.md#os.posix_fadvise "os.posix_fadvise"): Announces an intention to access data in a specific pattern thus allowing the kernel to make optimizations.

    * [`posix_fallocate()`](os.md#os.posix_fallocate "os.posix_fallocate"): Ensures that enough disk space is allocated for a file.

    * [`sync()`](os.md#os.sync "os.sync"): Force write of everything to disk.

  * Additional new posix functions:

    * [`lockf()`](os.md#os.lockf "os.lockf"): Apply, test or remove a POSIX lock on an open file descriptor.

    * [`pread()`](os.md#os.pread "os.pread"): Read from a file descriptor at an offset, the file offset remains unchanged.

    * [`pwrite()`](os.md#os.pwrite "os.pwrite"): Write to a file descriptor from an offset, leaving the file offset unchanged.

    * [`readv()`](os.md#os.readv "os.readv"): Read from a file descriptor into a number of writable buffers.

    * [`truncate()`](os.md#os.truncate "os.truncate"): Truncate the file corresponding to _path_ , so that it is at most _length_ bytes in size.

    * [`waitid()`](os.md#os.waitid "os.waitid"): Wait for the completion of one or more child processes.

    * [`writev()`](os.md#os.writev "os.writev"): Write the contents of _buffers_ to a file descriptor, where _buffers_ is an arbitrary sequence of buffers.

    * [`getgrouplist()`](os.md#os.getgrouplist "os.getgrouplist") ([bpo-9344](https://bugs.python.org/issue?@action=redirect&bpo=9344)): Return list of group ids that specified user belongs to.

  * [`times()`](os.md#os.times "os.times") and [`uname()`](os.md#os.uname "os.uname"): Return type changed from a tuple to a tuple-like object with named attributes.

  * Some platforms now support additional constants for the [`lseek()`](os.md#os.lseek "os.lseek") function, such as `os.SEEK_HOLE` and `os.SEEK_DATA`.

  * New constants [`RTLD_LAZY`](os.md#os.RTLD_LAZY "os.RTLD_LAZY"), [`RTLD_NOW`](os.md#os.RTLD_NOW "os.RTLD_NOW"), [`RTLD_GLOBAL`](os.md#os.RTLD_GLOBAL "os.RTLD_GLOBAL"), [`RTLD_LOCAL`](os.md#os.RTLD_LOCAL "os.RTLD_LOCAL"), [`RTLD_NODELETE`](os.md#os.RTLD_NODELETE "os.RTLD_NODELETE"), [`RTLD_NOLOAD`](os.md#os.RTLD_NOLOAD "os.RTLD_NOLOAD"), and [`RTLD_DEEPBIND`](os.md#os.RTLD_DEEPBIND "os.RTLD_DEEPBIND") are available on platforms that support them. These are for use with the [`sys.setdlopenflags()`](3.标准库/sys.md#sys.setdlopenflags "sys.setdlopenflags") function, and supersede the similar constants defined in [`ctypes`](ctypes.md#module-ctypes "ctypes: A foreign function library for Python.") and `DLFCN`. (Contributed by Victor Stinner in [bpo-13226](https://bugs.python.org/issue?@action=redirect&bpo=13226).)

  * [`os.symlink()`](os.md#os.symlink "os.symlink") now accepts (and ignores) the `target_is_directory` keyword argument on non-Windows platforms, to ease cross-platform support.

### pdb¶

Tab-completion is now available not only for command names, but also their arguments. For example, for the `break` command, function and file names are completed.

（由 Georg Brandl 在 [bpo-14210](https://bugs.python.org/issue?@action=redirect&bpo=14210) 中贡献）

### pickle¶

[`pickle.Pickler`](pickle.md#pickle.Pickler "pickle.Pickler") objects now have an optional [`dispatch_table`](pickle.md#pickle.Pickler.dispatch_table "pickle.Pickler.dispatch_table") attribute allowing per-pickler reduction functions to be set.

（由 Richard Oudkerk 在 [bpo-14166](https://bugs.python.org/issue?@action=redirect&bpo=14166) 中贡献。）

### pydoc¶

The Tk GUI and the `serve()` function have been removed from the [`pydoc`](pydoc.md#module-pydoc "pydoc: Documentation generator and online help system.") module: `pydoc -g` and `serve()` have been deprecated in Python 3.2.

### re¶

[`str`](stdtypes.md#str "str") regular expressions now support `\u` and `\U` escapes.

（由 Serhiy Storchaka 在 [bpo-3665](https://bugs.python.org/issue?@action=redirect&bpo=3665) 中贡献。）

### sched¶

  * [`run()`](sched.md#sched.scheduler.run "sched.scheduler.run") now accepts a _blocking_ parameter which when set to false makes the method execute the scheduled events due to expire soonest (if any) and then return immediately. This is useful in case you want to use the [`scheduler`](sched.md#sched.scheduler "sched.scheduler") in non-blocking applications. (Contributed by Giampaolo Rodolà in [bpo-13449](https://bugs.python.org/issue?@action=redirect&bpo=13449).)

  * [`scheduler`](sched.md#sched.scheduler "sched.scheduler") class can now be safely used in multi-threaded environments. (Contributed by Josiah Carlson and Giampaolo Rodolà in [bpo-8684](https://bugs.python.org/issue?@action=redirect&bpo=8684).)

  * _timefunc_ and _delayfunct_ parameters of [`scheduler`](sched.md#sched.scheduler "sched.scheduler") class constructor are now optional and defaults to [`time.time()`](time.md#time.time "time.time") and [`time.sleep()`](time.md#time.sleep "time.sleep") respectively. (Contributed by Chris Clark in [bpo-13245](https://bugs.python.org/issue?@action=redirect&bpo=13245).)

  * [`enter()`](sched.md#sched.scheduler.enter "sched.scheduler.enter") and [`enterabs()`](sched.md#sched.scheduler.enterabs "sched.scheduler.enterabs") _argument_ parameter is now optional. (Contributed by Chris Clark in [bpo-13245](https://bugs.python.org/issue?@action=redirect&bpo=13245).)

  * [`enter()`](sched.md#sched.scheduler.enter "sched.scheduler.enter") and [`enterabs()`](sched.md#sched.scheduler.enterabs "sched.scheduler.enterabs") now accept a _kwargs_ parameter. (Contributed by Chris Clark in [bpo-13245](https://bugs.python.org/issue?@action=redirect&bpo=13245).)

### select¶

Solaris and derivative platforms have a new class [`select.devpoll`](select.md#select.devpoll "select.devpoll") for high performance asynchronous sockets via `/dev/poll`. (Contributed by Jesús Cea Avión in [bpo-6397](https://bugs.python.org/issue?@action=redirect&bpo=6397).)

### shlex¶

The previously undocumented helper function `quote` from the `pipes` modules has been moved to the [`shlex`](shlex.md#module-shlex "shlex: Simple lexical analysis for Unix shell-like languages.") module and documented. [`quote()`](shlex.md#shlex.quote "shlex.quote") properly escapes all characters in a string that might be otherwise given special meaning by the shell.

### shutil¶

  * 新的函数：

    * [`disk_usage()`](shutil.md#shutil.disk_usage "shutil.disk_usage"): provides total, used and free disk space statistics. (Contributed by Giampaolo Rodolà in [bpo-12442](https://bugs.python.org/issue?@action=redirect&bpo=12442).)

    * [`chown()`](shutil.md#shutil.chown "shutil.chown"): allows one to change user and/or group of the given path also specifying the user/group names and not only their numeric ids. (Contributed by Sandro Tosi in [bpo-12191](https://bugs.python.org/issue?@action=redirect&bpo=12191).)

    * [`shutil.get_terminal_size()`](shutil.md#shutil.get_terminal_size "shutil.get_terminal_size"): returns the size of the terminal window to which the interpreter is attached. (Contributed by Zbigniew Jędrzejewski-Szmek in [bpo-13609](https://bugs.python.org/issue?@action=redirect&bpo=13609).)

  * [`copy2()`](shutil.md#shutil.copy2 "shutil.copy2") and [`copystat()`](shutil.md#shutil.copystat "shutil.copystat") now preserve file timestamps with nanosecond precision on platforms that support it. They also preserve file "extended attributes" on Linux. (Contributed by Larry Hastings in [bpo-14127](https://bugs.python.org/issue?@action=redirect&bpo=14127) and [bpo-15238](https://bugs.python.org/issue?@action=redirect&bpo=15238).)

  * Several functions now take an optional `symlinks` argument: when that parameter is true, symlinks aren't dereferenced and the operation instead acts on the symlink itself (or creates one, if relevant). (Contributed by Hynek Schlawack in [bpo-12715](https://bugs.python.org/issue?@action=redirect&bpo=12715).)

  * When copying files to a different file system, [`move()`](shutil.md#shutil.move "shutil.move") now handles symlinks the way the posix `mv` command does, recreating the symlink rather than copying the target file contents. (Contributed by Jonathan Niehof in [bpo-9993](https://bugs.python.org/issue?@action=redirect&bpo=9993).) [`move()`](shutil.md#shutil.move "shutil.move") now also returns the `dst` argument as its result.

  * [`rmtree()`](shutil.md#shutil.rmtree "shutil.rmtree") is now resistant to symlink attacks on platforms which support the new `dir_fd` parameter in [`os.open()`](os.md#os.open "os.open") and [`os.unlink()`](os.md#os.unlink "os.unlink"). (Contributed by Martin von Löwis and Hynek Schlawack in [bpo-4489](https://bugs.python.org/issue?@action=redirect&bpo=4489).)

### signal¶

  * [`signal`](signal.md#module-signal "signal: Set handlers for asynchronous events.") 模块新增的函数:

    * [`pthread_sigmask()`](signal.md#signal.pthread_sigmask "signal.pthread_sigmask"): 获取和/或改变调用方线程的信号掩码（由 Jean-Paul Calderone 在 [bpo-8407](https://bugs.python.org/issue?@action=redirect&bpo=8407) 中贡献）；

    * [`pthread_kill()`](signal.md#signal.pthread_kill "signal.pthread_kill"): 向指定线程发送信号；

    * [`sigpending()`](signal.md#signal.sigpending "signal.sigpending"): 检查挂起的函数；

    * [`sigwait()`](signal.md#signal.sigwait "signal.sigwait"): 等待一个信号;

    * [`sigwaitinfo()`](signal.md#signal.sigwaitinfo "signal.sigwaitinfo"): 等待信号，返回相关的详细信息；

    * [`sigtimedwait()`](signal.md#signal.sigtimedwait "signal.sigtimedwait"): like [`sigwaitinfo()`](signal.md#signal.sigwaitinfo "signal.sigwaitinfo") but with a timeout.

  * The signal handler writes the signal number as a single byte instead of a nul byte into the wakeup file descriptor. So it is possible to wait more than one signal and know which signals were raised.

  * [`signal.signal()`](signal.md#signal.signal "signal.signal") and [`signal.siginterrupt()`](signal.md#signal.siginterrupt "signal.siginterrupt") raise an OSError, instead of a RuntimeError: OSError has an errno attribute.

### smtpd¶

The `smtpd` module now supports [**RFC 5321**](https://datatracker.ietf.org/doc/html/rfc5321.md) (extended SMTP) and [**RFC 1870**](https://datatracker.ietf.org/doc/html/rfc1870.md) (size extension). Per the standard, these extensions are enabled if and only if the client initiates the session with an `EHLO` command.

(Initial `ELHO` support by Alberto Trevino. Size extension by Juhana Jauhiainen. Substantial additional work on the patch contributed by Michele Orrù and Dan Boswell. [bpo-8739](https://bugs.python.org/issue?@action=redirect&bpo=8739))

### smtplib¶

The [`SMTP`](smtplib.md#smtplib.SMTP "smtplib.SMTP"), [`SMTP_SSL`](smtplib.md#smtplib.SMTP_SSL "smtplib.SMTP_SSL"), and [`LMTP`](smtplib.md#smtplib.LMTP "smtplib.LMTP") classes now accept a `source_address` keyword argument to specify the `(host, port)` to use as the source address in the bind call when creating the outgoing socket. (Contributed by Paulo Scardine in [bpo-11281](https://bugs.python.org/issue?@action=redirect&bpo=11281).)

[`SMTP`](smtplib.md#smtplib.SMTP "smtplib.SMTP") now supports the context management protocol, allowing an `SMTP` instance to be used in a `with` statement. (Contributed by Giampaolo Rodolà in [bpo-11289](https://bugs.python.org/issue?@action=redirect&bpo=11289).)

The [`SMTP_SSL`](smtplib.md#smtplib.SMTP_SSL "smtplib.SMTP_SSL") constructor and the [`starttls()`](smtplib.md#smtplib.SMTP.starttls "smtplib.SMTP.starttls") method now accept an SSLContext parameter to control parameters of the secure channel. (Contributed by Kasun Herath in [bpo-8809](https://bugs.python.org/issue?@action=redirect&bpo=8809).)

### socket¶

  * The [`socket`](socket.md#socket.socket "socket.socket") class now exposes additional methods to process ancillary data when supported by the underlying platform:

    * [`sendmsg()`](socket.md#socket.socket.sendmsg "socket.socket.sendmsg")

    * [`recvmsg()`](socket.md#socket.socket.recvmsg "socket.socket.recvmsg")

    * [`recvmsg_into()`](socket.md#socket.socket.recvmsg_into "socket.socket.recvmsg_into")

(Contributed by David Watson in [bpo-6560](https://bugs.python.org/issue?@action=redirect&bpo=6560), based on an earlier patch by Heiko Wundram)

  * The [`socket`](socket.md#socket.socket "socket.socket") class now supports the PF_CAN protocol family (<https://en.wikipedia.org/wiki/Socketcan>), on Linux (<https://lwn.net/Articles/253425>).

(Contributed by Matthias Fuchs, updated by Tiago Gonçalves in [bpo-10141](https://bugs.python.org/issue?@action=redirect&bpo=10141).)

  * The [`socket`](socket.md#socket.socket "socket.socket") class now supports the PF_RDS protocol family (<https://en.wikipedia.org/wiki/Reliable_Datagram_Sockets> and [https://oss.oracle.com/projects/rds](https://web.archive.org/web/20130115155505/https://oss.oracle.com/projects/rds/)).

  * The [`socket`](socket.md#socket.socket "socket.socket") class now supports the `PF_SYSTEM` protocol family on OS X. (Contributed by Michael Goderbauer in [bpo-13777](https://bugs.python.org/issue?@action=redirect&bpo=13777).)

  * New function [`sethostname()`](socket.md#socket.sethostname "socket.sethostname") allows the hostname to be set on Unix systems if the calling process has sufficient privileges. (Contributed by Ross Lagerwall in [bpo-10866](https://bugs.python.org/issue?@action=redirect&bpo=10866).)

### socketserver¶

[`BaseServer`](socketserver.md#socketserver.BaseServer "socketserver.BaseServer") now has an overridable method [`service_actions()`](socketserver.md#socketserver.BaseServer.service_actions "socketserver.BaseServer.service_actions") that is called by the [`serve_forever()`](socketserver.md#socketserver.BaseServer.serve_forever "socketserver.BaseServer.serve_forever") method in the service loop. [`ForkingMixIn`](socketserver.md#socketserver.ForkingMixIn "socketserver.ForkingMixIn") now uses this to clean up zombie child processes. (Contributed by Justin Warkentin in [bpo-11109](https://bugs.python.org/issue?@action=redirect&bpo=11109).)

### sqlite3¶

New [`sqlite3.Connection`](sqlite3.md#sqlite3.Connection "sqlite3.Connection") method [`set_trace_callback()`](sqlite3.md#sqlite3.Connection.set_trace_callback "sqlite3.Connection.set_trace_callback") can be used to capture a trace of all sql commands processed by sqlite. (Contributed by Torsten Landschoff in [bpo-11688](https://bugs.python.org/issue?@action=redirect&bpo=11688).)

### ssl¶

  * The [`ssl`](ssl.md#module-ssl "ssl: TLS/SSL wrapper for socket objects") module has two new random generation functions:

    * [`RAND_bytes()`](ssl.md#ssl.RAND_bytes "ssl.RAND_bytes"): generate cryptographically strong pseudo-random bytes.

    * `RAND_pseudo_bytes()`: 生成伪随机字节。

（由 Victor Stinner 在 [bpo-12049](https://bugs.python.org/issue?@action=redirect&bpo=12049) 中贡献。）

  * The [`ssl`](ssl.md#module-ssl "ssl: TLS/SSL wrapper for socket objects") module now exposes a finer-grained exception hierarchy in order to make it easier to inspect the various kinds of errors. (Contributed by Antoine Pitrou in [bpo-11183](https://bugs.python.org/issue?@action=redirect&bpo=11183).)

  * [`load_cert_chain()`](ssl.md#ssl.SSLContext.load_cert_chain "ssl.SSLContext.load_cert_chain") now accepts a _password_ argument to be used if the private key is encrypted. (Contributed by Adam Simpkins in [bpo-12803](https://bugs.python.org/issue?@action=redirect&bpo=12803).)

  * Diffie-Hellman key exchange, both regular and Elliptic Curve-based, is now supported through the [`load_dh_params()`](ssl.md#ssl.SSLContext.load_dh_params "ssl.SSLContext.load_dh_params") and [`set_ecdh_curve()`](ssl.md#ssl.SSLContext.set_ecdh_curve "ssl.SSLContext.set_ecdh_curve") methods. (Contributed by Antoine Pitrou in [bpo-13626](https://bugs.python.org/issue?@action=redirect&bpo=13626) and [bpo-13627](https://bugs.python.org/issue?@action=redirect&bpo=13627).)

  * SSL sockets have a new [`get_channel_binding()`](ssl.md#ssl.SSLSocket.get_channel_binding "ssl.SSLSocket.get_channel_binding") method allowing the implementation of certain authentication mechanisms such as SCRAM-SHA-1-PLUS. (Contributed by Jacek Konieczny in [bpo-12551](https://bugs.python.org/issue?@action=redirect&bpo=12551).)

  * You can query the SSL compression algorithm used by an SSL socket, thanks to its new [`compression()`](ssl.md#ssl.SSLSocket.compression "ssl.SSLSocket.compression") method. The new attribute [`OP_NO_COMPRESSION`](ssl.md#ssl.OP_NO_COMPRESSION "ssl.OP_NO_COMPRESSION") can be used to disable compression. (Contributed by Antoine Pitrou in [bpo-13634](https://bugs.python.org/issue?@action=redirect&bpo=13634).)

  * Support has been added for the Next Protocol Negotiation extension using the [`ssl.SSLContext.set_npn_protocols()`](ssl.md#ssl.SSLContext.set_npn_protocols "ssl.SSLContext.set_npn_protocols") method. (Contributed by Colin Marc in [bpo-14204](https://bugs.python.org/issue?@action=redirect&bpo=14204).)

  * SSL errors can now be introspected more easily thanks to [`library`](ssl.md#ssl.SSLError.library "ssl.SSLError.library") and [`reason`](ssl.md#ssl.SSLError.reason "ssl.SSLError.reason") attributes. (Contributed by Antoine Pitrou in [bpo-14837](https://bugs.python.org/issue?@action=redirect&bpo=14837).)

  * The [`get_server_certificate()`](ssl.md#ssl.get_server_certificate "ssl.get_server_certificate") function now supports IPv6. (Contributed by Charles-François Natali in [bpo-11811](https://bugs.python.org/issue?@action=redirect&bpo=11811).)

  * New attribute [`OP_CIPHER_SERVER_PREFERENCE`](ssl.md#ssl.OP_CIPHER_SERVER_PREFERENCE "ssl.OP_CIPHER_SERVER_PREFERENCE") allows setting SSLv3 server sockets to use the server's cipher ordering preference rather than the client's ([bpo-13635](https://bugs.python.org/issue?@action=redirect&bpo=13635)).

### stat¶

The undocumented tarfile.filemode function has been moved to [`stat.filemode()`](stat.md#stat.filemode "stat.filemode"). It can be used to convert a file's mode to a string of the form '-rwxrwxrwx'.

（由 Giampaolo Rodolà 在 [bpo-14807](https://bugs.python.org/issue?@action=redirect&bpo=14807) 中贡献。）

### struct¶

The [`struct`](struct.md#module-struct "struct: Interpret bytes as packed binary data.") module now supports `ssize_t` and `size_t` via the new codes `n` and `N`, respectively. (Contributed by Antoine Pitrou in [bpo-3163](https://bugs.python.org/issue?@action=redirect&bpo=3163).)

### subprocess¶

Command strings can now be bytes objects on posix platforms. (Contributed by Victor Stinner in [bpo-8513](https://bugs.python.org/issue?@action=redirect&bpo=8513).)

A new constant [`DEVNULL`](subprocess.md#subprocess.DEVNULL "subprocess.DEVNULL") allows suppressing output in a platform-independent fashion. (Contributed by Ross Lagerwall in [bpo-5870](https://bugs.python.org/issue?@action=redirect&bpo=5870).)

### sys¶

The [`sys`](3.标准库/sys.md#module-sys "sys: Access system-specific parameters and functions.") module has a new [`thread_info`](3.标准库/sys.md#sys.thread_info "sys.thread_info") [named tuple](../glossary.md#term-named-tuple) holding information about the thread implementation ([bpo-11223](https://bugs.python.org/issue?@action=redirect&bpo=11223)).

### tarfile¶

[`tarfile`](tarfile.md#module-tarfile "tarfile: Read and write tar-format archive files.") now supports `lzma` encoding via the [`lzma`](lzma.md#module-lzma "lzma: A Python wrapper for the liblzma compression library.") module. (Contributed by Lars Gustäbel in [bpo-5689](https://bugs.python.org/issue?@action=redirect&bpo=5689).)

### tempfile¶

[`tempfile.SpooledTemporaryFile`](tempfile.md#tempfile.SpooledTemporaryFile "tempfile.SpooledTemporaryFile")'s `truncate()` method now accepts a `size` parameter. (Contributed by Ryan Kelly in [bpo-9957](https://bugs.python.org/issue?@action=redirect&bpo=9957).)

### textwrap¶

The [`textwrap`](textwrap.md#module-textwrap "textwrap: Text wrapping and filling") module has a new [`indent()`](textwrap.md#textwrap.indent "textwrap.indent") that makes it straightforward to add a common prefix to selected lines in a block of text ([bpo-13857](https://bugs.python.org/issue?@action=redirect&bpo=13857)).

### threading¶

[`threading.Condition`](threading.md#threading.Condition "threading.Condition"), [`threading.Semaphore`](threading.md#threading.Semaphore "threading.Semaphore"), [`threading.BoundedSemaphore`](threading.md#threading.BoundedSemaphore "threading.BoundedSemaphore"), [`threading.Event`](threading.md#threading.Event "threading.Event"), and [`threading.Timer`](threading.md#threading.Timer "threading.Timer"), all of which used to be factory functions returning a class instance, are now classes and may be subclassed. (Contributed by Éric Araujo in [bpo-10968](https://bugs.python.org/issue?@action=redirect&bpo=10968).)

The [`threading.Thread`](threading.md#threading.Thread "threading.Thread") constructor now accepts a `daemon` keyword argument to override the default behavior of inheriting the `daemon` flag value from the parent thread ([bpo-6064](https://bugs.python.org/issue?@action=redirect&bpo=6064)).

The formerly private function `_thread.get_ident` is now available as the public function [`threading.get_ident()`](threading.md#threading.get_ident "threading.get_ident"). This eliminates several cases of direct access to the `_thread` module in the stdlib. Third party code that used `_thread.get_ident` should likewise be changed to use the new public interface.

### time¶

The [**PEP 418**](https://peps.python.org/pep-0418/) added new functions to the [`time`](time.md#module-time "time: Time access and conversions.") module:

  * [`get_clock_info()`](time.md#time.get_clock_info "time.get_clock_info"): Get information on a clock.

  * [`monotonic()`](time.md#time.monotonic "time.monotonic"): Monotonic clock (cannot go backward), not affected by system clock updates.

  * [`perf_counter()`](time.md#time.perf_counter "time.perf_counter"): Performance counter with the highest available resolution to measure a short duration.

  * [`process_time()`](time.md#time.process_time "time.process_time"): Sum of the system and user CPU time of the current process.

Other new functions:

  * [`clock_getres()`](time.md#time.clock_getres "time.clock_getres"), [`clock_gettime()`](time.md#time.clock_gettime "time.clock_gettime") and [`clock_settime()`](time.md#time.clock_settime "time.clock_settime") functions with `CLOCK_xxx` constants. (Contributed by Victor Stinner in [bpo-10278](https://bugs.python.org/issue?@action=redirect&bpo=10278).)

To improve cross platform consistency, [`sleep()`](time.md#time.sleep "time.sleep") now raises a [`ValueError`](3.标准库/exceptions.md#ValueError "ValueError") when passed a negative sleep value. Previously this was an error on posix, but produced an infinite sleep on Windows.

### types¶

Add a new [`types.MappingProxyType`](types.md#types.MappingProxyType "types.MappingProxyType") class: Read-only proxy of a mapping. ([bpo-14386](https://bugs.python.org/issue?@action=redirect&bpo=14386))

The new functions [`types.new_class()`](types.md#types.new_class "types.new_class") and [`types.prepare_class()`](types.md#types.prepare_class "types.prepare_class") provide support for [**PEP 3115**](https://peps.python.org/pep-3115/) compliant dynamic type creation. ([bpo-14588](https://bugs.python.org/issue?@action=redirect&bpo=14588))

### unittest¶

[`assertRaises()`](unittest.md#unittest.TestCase.assertRaises "unittest.TestCase.assertRaises"), [`assertRaisesRegex()`](unittest.md#unittest.TestCase.assertRaisesRegex "unittest.TestCase.assertRaisesRegex"), [`assertWarns()`](unittest.md#unittest.TestCase.assertWarns "unittest.TestCase.assertWarns"), and [`assertWarnsRegex()`](unittest.md#unittest.TestCase.assertWarnsRegex "unittest.TestCase.assertWarnsRegex") now accept a keyword argument _msg_ when used as context managers. (Contributed by Ezio Melotti and Winston Ewert in [bpo-10775](https://bugs.python.org/issue?@action=redirect&bpo=10775).)

[`unittest.TestCase.run()`](unittest.md#unittest.TestCase.run "unittest.TestCase.run") now returns the [`TestResult`](unittest.md#unittest.TestResult "unittest.TestResult") object.

### urllib¶

The [`Request`](urllib.request.md#urllib.request.Request "urllib.request.Request") class, now accepts a _method_ argument used by [`get_method()`](urllib.request.md#urllib.request.Request.get_method "urllib.request.Request.get_method") to determine what HTTP method should be used. For example, this will send a `'HEAD'` request:

    
    
~~~shell
>>> urlopen(Request('https://www.python.org', method='HEAD'))
~~~

([bpo-1673007](https://bugs.python.org/issue?@action=redirect&bpo=1673007))

### webbrowser¶

The [`webbrowser`](webbrowser.md#module-webbrowser "webbrowser: Easy-to-use controller for web browsers.") module supports more "browsers": Google Chrome (named **chrome** , **chromium** , **chrome-browser** or **chromium-browser** depending on the version and operating system), and the generic launchers **xdg-open** , from the FreeDesktop.org project, and **gvfs-open** , which is the default URI handler for GNOME 3\. (The former contributed by Arnaud Calmettes in [bpo-13620](https://bugs.python.org/issue?@action=redirect&bpo=13620), the latter by Matthias Klose in [bpo-14493](https://bugs.python.org/issue?@action=redirect&bpo=14493).)

### xml.etree.ElementTree¶

The [`xml.etree.ElementTree`](xml.etree.elementtree.md#module-xml.etree.ElementTree "xml.etree.ElementTree: Implementation of the ElementTree API.") module now imports its C accelerator by default; there is no longer a need to explicitly import `xml.etree.cElementTree` (this module stays for backwards compatibility, but is now deprecated). In addition, the `iter` family of methods of [`Element`](xml.etree.elementtree.md#xml.etree.ElementTree.Element "xml.etree.ElementTree.Element") has been optimized (rewritten in C). The module's documentation has also been greatly improved with added examples and a more detailed reference.

### zlib¶

New attribute [`zlib.Decompress.eof`](zlib.md#zlib.Decompress.eof "zlib.Decompress.eof") makes it possible to distinguish between a properly formed compressed stream and an incomplete or truncated one. (Contributed by Nadeem Vawda in [bpo-12646](https://bugs.python.org/issue?@action=redirect&bpo=12646).)

New attribute [`zlib.ZLIB_RUNTIME_VERSION`](zlib.md#zlib.ZLIB_RUNTIME_VERSION "zlib.ZLIB_RUNTIME_VERSION") reports the version string of the underlying `zlib` library that is loaded at runtime. (Contributed by Torsten Landschoff in [bpo-12306](https://bugs.python.org/issue?@action=redirect&bpo=12306).)

## 性能优化¶

已增加的主要性能改善:

  * Thanks to [**PEP 393**](https://peps.python.org/pep-0393/), some operations on Unicode strings have been optimized:

    * the memory footprint is divided by 2 to 4 depending on the text

    * encode an ASCII string to UTF-8 doesn't need to encode characters anymore, the UTF-8 representation is shared with the ASCII representation

    * the UTF-8 encoder has been optimized

    * repeating a single ASCII letter and getting a substring of an ASCII string is 4 times faster

  * UTF-8 is now 2x to 4x faster. UTF-16 encoding is now up to 10x faster.

(Contributed by Serhiy Storchaka, [bpo-14624](https://bugs.python.org/issue?@action=redirect&bpo=14624), [bpo-14738](https://bugs.python.org/issue?@action=redirect&bpo=14738) and [bpo-15026](https://bugs.python.org/issue?@action=redirect&bpo=15026).)

## 构建和 C API 的改变¶

针对 Python 构建过程和 C API 的改变包括:

  * 新的 [**PEP 3118**](https://peps.python.org/pep-3118/) 相关功能：

    * [`PyMemoryView_FromMemory()`](memoryview.md#c.PyMemoryView_FromMemory "PyMemoryView_FromMemory")

  * [**PEP 393**](https://peps.python.org/pep-0393/) 添加了新的 Unicode 类型，宏和函数

    * 高阶 API

      * [`PyUnicode_CopyCharacters()`](10.C%20API接口/unicode.md#c.PyUnicode_CopyCharacters "PyUnicode_CopyCharacters")

      * [`PyUnicode_FindChar()`](10.C%20API接口/unicode.md#c.PyUnicode_FindChar "PyUnicode_FindChar")

      * [`PyUnicode_GetLength()`](10.C%20API接口/unicode.md#c.PyUnicode_GetLength "PyUnicode_GetLength"), [`PyUnicode_GET_LENGTH`](10.C%20API接口/unicode.md#c.PyUnicode_GET_LENGTH "PyUnicode_GET_LENGTH")

      * [`PyUnicode_New()`](10.C%20API接口/unicode.md#c.PyUnicode_New "PyUnicode_New")

      * [`PyUnicode_Substring()`](10.C%20API接口/unicode.md#c.PyUnicode_Substring "PyUnicode_Substring")

      * [`PyUnicode_ReadChar()`](10.C%20API接口/unicode.md#c.PyUnicode_ReadChar "PyUnicode_ReadChar"), [`PyUnicode_WriteChar()`](10.C%20API接口/unicode.md#c.PyUnicode_WriteChar "PyUnicode_WriteChar")

    * 低阶 API:

      * [`Py_UCS1`](10.C%20API接口/unicode.md#c.Py_UCS1 "Py_UCS1"), [`Py_UCS2`](10.C%20API接口/unicode.md#c.Py_UCS2 "Py_UCS2"), [`Py_UCS4`](10.C%20API接口/unicode.md#c.Py_UCS4 "Py_UCS4") 类型

      * [`PyASCIIObject`](10.C%20API接口/unicode.md#c.PyASCIIObject "PyASCIIObject") 和 [`PyCompactUnicodeObject`](10.C%20API接口/unicode.md#c.PyCompactUnicodeObject "PyCompactUnicodeObject") 结构

      * [`PyUnicode_READY`](10.C%20API接口/unicode.md#c.PyUnicode_READY "PyUnicode_READY")

      * [`PyUnicode_FromKindAndData()`](10.C%20API接口/unicode.md#c.PyUnicode_FromKindAndData "PyUnicode_FromKindAndData")

      * [`PyUnicode_AsUCS4()`](10.C%20API接口/unicode.md#c.PyUnicode_AsUCS4 "PyUnicode_AsUCS4"), [`PyUnicode_AsUCS4Copy()`](10.C%20API接口/unicode.md#c.PyUnicode_AsUCS4Copy "PyUnicode_AsUCS4Copy")

      * [`PyUnicode_DATA`](10.C%20API接口/unicode.md#c.PyUnicode_DATA "PyUnicode_DATA"), [`PyUnicode_1BYTE_DATA`](10.C%20API接口/unicode.md#c.PyUnicode_1BYTE_DATA "PyUnicode_1BYTE_DATA"), [`PyUnicode_2BYTE_DATA`](10.C%20API接口/unicode.md#c.PyUnicode_2BYTE_DATA "PyUnicode_2BYTE_DATA"), [`PyUnicode_4BYTE_DATA`](10.C%20API接口/unicode.md#c.PyUnicode_4BYTE_DATA "PyUnicode_4BYTE_DATA")

      * [`PyUnicode_KIND`](10.C%20API接口/unicode.md#c.PyUnicode_KIND "PyUnicode_KIND") with `PyUnicode_Kind` enum: `PyUnicode_WCHAR_KIND`, [`PyUnicode_1BYTE_KIND`](10.C%20API接口/unicode.md#c.PyUnicode_1BYTE_KIND "PyUnicode_1BYTE_KIND"), [`PyUnicode_2BYTE_KIND`](10.C%20API接口/unicode.md#c.PyUnicode_2BYTE_KIND "PyUnicode_2BYTE_KIND"), [`PyUnicode_4BYTE_KIND`](10.C%20API接口/unicode.md#c.PyUnicode_4BYTE_KIND "PyUnicode_4BYTE_KIND")

      * [`PyUnicode_READ`](10.C%20API接口/unicode.md#c.PyUnicode_READ "PyUnicode_READ"), [`PyUnicode_READ_CHAR`](10.C%20API接口/unicode.md#c.PyUnicode_READ_CHAR "PyUnicode_READ_CHAR"), [`PyUnicode_WRITE`](10.C%20API接口/unicode.md#c.PyUnicode_WRITE "PyUnicode_WRITE")

      * [`PyUnicode_MAX_CHAR_VALUE`](10.C%20API接口/unicode.md#c.PyUnicode_MAX_CHAR_VALUE "PyUnicode_MAX_CHAR_VALUE")

  * [`PyArg_ParseTuple`](arg.md#c.PyArg_ParseTuple "PyArg_ParseTuple") 现在接受 `c` 格式的 [`bytearray`](stdtypes.md#bytearray "bytearray") ([bpo-12380](https://bugs.python.org/issue?@action=redirect&bpo=12380))。

## 弃用¶

### 不支持的操作系统¶

由于缺少维护人员，不再支持 OS/2 和 VMS 系统 。

由于维护负担，将 `COMSPEC` 设置为 `command.com` 的 Windows平台（含Windows 2000）不再受支持。

OSF支持在3.2中被弃用，现在已经被完全删除。

### 已弃用的 Python 模块、函数和方法¶

  * Passing a non-empty string to `object.__format__()` is deprecated, and will produce a [`TypeError`](3.标准库/exceptions.md#TypeError "TypeError") in Python 3.4 ([bpo-9856](https://bugs.python.org/issue?@action=redirect&bpo=9856)).

  * The `unicode_internal` codec has been deprecated because of the [**PEP 393**](https://peps.python.org/pep-0393/), use UTF-8, UTF-16 (`utf-16-le` or `utf-16-be`), or UTF-32 (`utf-32-le` or `utf-32-be`)

  * [`ftplib.FTP.nlst()`](ftplib.md#ftplib.FTP.nlst "ftplib.FTP.nlst") and [`ftplib.FTP.dir()`](ftplib.md#ftplib.FTP.dir "ftplib.FTP.dir"): use [`ftplib.FTP.mlsd()`](ftplib.md#ftplib.FTP.mlsd "ftplib.FTP.mlsd")

  * `platform.popen()`: use the [`subprocess`](subprocess.md#module-subprocess "subprocess: Subprocess management.") module. Check especially the [使用 subprocess 模块替换旧函数](subprocess.md#subprocess-replacements) section ([bpo-11377](https://bugs.python.org/issue?@action=redirect&bpo=11377)).

  * [bpo-13374](https://bugs.python.org/issue?@action=redirect&bpo=13374): The Windows bytes API has been deprecated in the [`os`](os.md#module-os "os: Miscellaneous operating system interfaces.") module. Use Unicode filenames, instead of bytes filenames, to not depend on the ANSI code page anymore and to support any filename.

  * [bpo-13988](https://bugs.python.org/issue?@action=redirect&bpo=13988): The `xml.etree.cElementTree` module is deprecated. The accelerator is used automatically whenever available.

  * The behaviour of `time.clock()` depends on the platform: use the new [`time.perf_counter()`](time.md#time.perf_counter "time.perf_counter") or [`time.process_time()`](time.md#time.process_time "time.process_time") function instead, depending on your requirements, to have a well defined behaviour.

  * The `os.stat_float_times()` function is deprecated.

  * [`abc`](abc.md#module-abc "abc: Abstract base classes according to :pep:`3119`.") module:

    * [`abc.abstractproperty`](abc.md#abc.abstractproperty "abc.abstractproperty") has been deprecated, use [`property`](functions.md#property "property") with [`abc.abstractmethod()`](abc.md#abc.abstractmethod "abc.abstractmethod") instead.

    * [`abc.abstractclassmethod`](abc.md#abc.abstractclassmethod "abc.abstractclassmethod") has been deprecated, use [`classmethod`](functions.md#classmethod "classmethod") with [`abc.abstractmethod()`](abc.md#abc.abstractmethod "abc.abstractmethod") instead.

    * [`abc.abstractstaticmethod`](abc.md#abc.abstractstaticmethod "abc.abstractstaticmethod") has been deprecated, use [`staticmethod`](functions.md#staticmethod "staticmethod") with [`abc.abstractmethod()`](abc.md#abc.abstractmethod "abc.abstractmethod") instead.

  * [`importlib`](importlib.md#module-importlib "importlib: The implementation of the import machinery.") package:

    * [`importlib.abc.SourceLoader.path_mtime()`](importlib.md#importlib.abc.SourceLoader.path_mtime "importlib.abc.SourceLoader.path_mtime") is now deprecated in favour of [`importlib.abc.SourceLoader.path_stats()`](importlib.md#importlib.abc.SourceLoader.path_stats "importlib.abc.SourceLoader.path_stats") as bytecode files now store both the modification time and size of the source file the bytecode file was compiled from.

### 已弃用的 C API 函数和类型¶

[`Py_UNICODE`](10.C%20API接口/unicode.md#c.Py_UNICODE "Py_UNICODE") 已经在 [**PEP 393**](https://peps.python.org/pep-0393/) 弃用，并将于 Python 4 中移除。所有使用此类型的函数都已弃用：

Unicode functions and methods using [`Py_UNICODE`](10.C%20API接口/unicode.md#c.Py_UNICODE "Py_UNICODE") and [Py_UNICODE](10.C%20API接口/unicode.md#c.Py_UNICODE "Py_UNICODE")* types:

  * `PyUnicode_FromUnicode`: use [`PyUnicode_FromWideChar()`](10.C%20API接口/unicode.md#c.PyUnicode_FromWideChar "PyUnicode_FromWideChar") or [`PyUnicode_FromKindAndData()`](10.C%20API接口/unicode.md#c.PyUnicode_FromKindAndData "PyUnicode_FromKindAndData")

  * `PyUnicode_AS_UNICODE`, `PyUnicode_AsUnicode()`, `PyUnicode_AsUnicodeAndSize()`: use [`PyUnicode_AsWideCharString()`](10.C%20API接口/unicode.md#c.PyUnicode_AsWideCharString "PyUnicode_AsWideCharString")

  * `PyUnicode_AS_DATA`: use [`PyUnicode_DATA`](10.C%20API接口/unicode.md#c.PyUnicode_DATA "PyUnicode_DATA") with [`PyUnicode_READ`](10.C%20API接口/unicode.md#c.PyUnicode_READ "PyUnicode_READ") and [`PyUnicode_WRITE`](10.C%20API接口/unicode.md#c.PyUnicode_WRITE "PyUnicode_WRITE")

  * `PyUnicode_GET_SIZE`, `PyUnicode_GetSize()`: use [`PyUnicode_GET_LENGTH`](10.C%20API接口/unicode.md#c.PyUnicode_GET_LENGTH "PyUnicode_GET_LENGTH") or [`PyUnicode_GetLength()`](10.C%20API接口/unicode.md#c.PyUnicode_GetLength "PyUnicode_GetLength")

  * `PyUnicode_GET_DATA_SIZE`: use `PyUnicode_GET_LENGTH(str) * PyUnicode_KIND(str)` (only work on ready strings)

  * `PyUnicode_AsUnicodeCopy()`: use [`PyUnicode_AsUCS4Copy()`](10.C%20API接口/unicode.md#c.PyUnicode_AsUCS4Copy "PyUnicode_AsUCS4Copy") or [`PyUnicode_AsWideCharString()`](10.C%20API接口/unicode.md#c.PyUnicode_AsWideCharString "PyUnicode_AsWideCharString")

  * `PyUnicode_GetMax()`

Functions and macros manipulating Py_UNICODE* strings:

  * `Py_UNICODE_strlen()`: use [`PyUnicode_GetLength()`](10.C%20API接口/unicode.md#c.PyUnicode_GetLength "PyUnicode_GetLength") or [`PyUnicode_GET_LENGTH`](10.C%20API接口/unicode.md#c.PyUnicode_GET_LENGTH "PyUnicode_GET_LENGTH")

  * `Py_UNICODE_strcat()`: use [`PyUnicode_CopyCharacters()`](10.C%20API接口/unicode.md#c.PyUnicode_CopyCharacters "PyUnicode_CopyCharacters") or [`PyUnicode_FromFormat()`](10.C%20API接口/unicode.md#c.PyUnicode_FromFormat "PyUnicode_FromFormat")

  * `Py_UNICODE_strcpy()`, `Py_UNICODE_strncpy()`, `Py_UNICODE_COPY()`: use [`PyUnicode_CopyCharacters()`](10.C%20API接口/unicode.md#c.PyUnicode_CopyCharacters "PyUnicode_CopyCharacters") or [`PyUnicode_Substring()`](10.C%20API接口/unicode.md#c.PyUnicode_Substring "PyUnicode_Substring")

  * `Py_UNICODE_strcmp()`: use [`PyUnicode_Compare()`](10.C%20API接口/unicode.md#c.PyUnicode_Compare "PyUnicode_Compare")

  * `Py_UNICODE_strncmp()`: use [`PyUnicode_Tailmatch()`](10.C%20API接口/unicode.md#c.PyUnicode_Tailmatch "PyUnicode_Tailmatch")

  * `Py_UNICODE_strchr()`, `Py_UNICODE_strrchr()`: use [`PyUnicode_FindChar()`](10.C%20API接口/unicode.md#c.PyUnicode_FindChar "PyUnicode_FindChar")

  * `Py_UNICODE_FILL()`: use [`PyUnicode_Fill()`](10.C%20API接口/unicode.md#c.PyUnicode_Fill "PyUnicode_Fill")

  * `Py_UNICODE_MATCH`

编码器:

  * `PyUnicode_Encode()`: use `PyUnicode_AsEncodedObject()`

  * `PyUnicode_EncodeUTF7()`

  * `PyUnicode_EncodeUTF8()`: use [`PyUnicode_AsUTF8()`](10.C%20API接口/unicode.md#c.PyUnicode_AsUTF8 "PyUnicode_AsUTF8") or [`PyUnicode_AsUTF8String()`](10.C%20API接口/unicode.md#c.PyUnicode_AsUTF8String "PyUnicode_AsUTF8String")

  * `PyUnicode_EncodeUTF32()`

  * `PyUnicode_EncodeUTF16()`

  * `PyUnicode_EncodeUnicodeEscape()` use [`PyUnicode_AsUnicodeEscapeString()`](10.C%20API接口/unicode.md#c.PyUnicode_AsUnicodeEscapeString "PyUnicode_AsUnicodeEscapeString")

  * `PyUnicode_EncodeRawUnicodeEscape()` use [`PyUnicode_AsRawUnicodeEscapeString()`](10.C%20API接口/unicode.md#c.PyUnicode_AsRawUnicodeEscapeString "PyUnicode_AsRawUnicodeEscapeString")

  * `PyUnicode_EncodeLatin1()`: use [`PyUnicode_AsLatin1String()`](10.C%20API接口/unicode.md#c.PyUnicode_AsLatin1String "PyUnicode_AsLatin1String")

  * `PyUnicode_EncodeASCII()`: use [`PyUnicode_AsASCIIString()`](10.C%20API接口/unicode.md#c.PyUnicode_AsASCIIString "PyUnicode_AsASCIIString")

  * `PyUnicode_EncodeCharmap()`

  * `PyUnicode_TranslateCharmap()`

  * `PyUnicode_EncodeMBCS()`: use [`PyUnicode_AsMBCSString()`](10.C%20API接口/unicode.md#c.PyUnicode_AsMBCSString "PyUnicode_AsMBCSString") or [`PyUnicode_EncodeCodePage()`](10.C%20API接口/unicode.md#c.PyUnicode_EncodeCodePage "PyUnicode_EncodeCodePage") (with `CP_ACP` code_page)

  * `PyUnicode_EncodeDecimal()`, `PyUnicode_TransformDecimalToASCII()`

### 弃用的功能¶

The [`array`](array.md#module-array "array: Space efficient arrays of uniformly typed numeric values.") module's `'u'` format code is now deprecated and will be removed in Python 4 together with the rest of the ([`Py_UNICODE`](10.C%20API接口/unicode.md#c.Py_UNICODE "Py_UNICODE")) API.

## 移植到 Python 3.3¶

本节列出了先前描述的更改以及可能需要更改代码的其他错误修正.

### Porting Python code¶

  * Hash randomization is enabled by default. Set the [`PYTHONHASHSEED`](1.%20命令行与环境.md#envvar-PYTHONHASHSEED) environment variable to `0` to disable hash randomization. See also the [`object.__hash__()`](3.%20数据模型.md#object.__hash__ "object.__hash__") method.

  * [bpo-12326](https://bugs.python.org/issue?@action=redirect&bpo=12326): On Linux, sys.platform doesn't contain the major version anymore. It is now always 'linux', instead of 'linux2' or 'linux3' depending on the Linux version used to build Python. Replace sys.platform == 'linux2' with sys.platform.startswith('linux'), or directly sys.platform == 'linux' if you don't need to support older Python versions.

  * [bpo-13847](https://bugs.python.org/issue?@action=redirect&bpo=13847), [bpo-14180](https://bugs.python.org/issue?@action=redirect&bpo=14180): [`time`](time.md#module-time "time: Time access and conversions.") and [`datetime`](3.标准库/datetime.md#module-datetime "datetime: Basic date and time types."): [`OverflowError`](3.标准库/exceptions.md#OverflowError "OverflowError") is now raised instead of [`ValueError`](3.标准库/exceptions.md#ValueError "ValueError") if a timestamp is out of range. [`OSError`](3.标准库/exceptions.md#OSError "OSError") is now raised if C functions `gmtime()` or `localtime()` failed.

  * The default finders used by import now utilize a cache of what is contained within a specific directory. If you create a Python source file or sourceless bytecode file, make sure to call [`importlib.invalidate_caches()`](importlib.md#importlib.invalidate_caches "importlib.invalidate_caches") to clear out the cache for the finders to notice the new file.

  * [`ImportError`](3.标准库/exceptions.md#ImportError "ImportError") now uses the full name of the module that was attempted to be imported. Doctests that check ImportErrors' message will need to be updated to use the full name of the module instead of just the tail of the name.

  * The _index_ argument to [`__import__()`](functions.md#import__ "__import__") now defaults to 0 instead of -1 and no longer support negative values. It was an oversight when [**PEP 328**](https://peps.python.org/pep-0328/) was implemented that the default value remained -1. If you need to continue to perform a relative import followed by an absolute import, then perform the relative import using an index of 1, followed by another import using an index of 0. It is preferred, though, that you use [`importlib.import_module()`](importlib.md#importlib.import_module "importlib.import_module") rather than call [`__import__()`](functions.md#import__ "__import__") directly.

  * [`__import__()`](functions.md#import__ "__import__") no longer allows one to use an index value other than 0 for top-level modules. E.g. `__import__('sys', level=1)` is now an error.

  * Because [`sys.meta_path`](3.标准库/sys.md#sys.meta_path "sys.meta_path") and [`sys.path_hooks`](3.标准库/sys.md#sys.path_hooks "sys.path_hooks") now have finders on them by default, you will most likely want to use `list.insert()` instead of `list.append()` to add to those lists.

  * Because `None` is now inserted into [`sys.path_importer_cache`](3.标准库/sys.md#sys.path_importer_cache "sys.path_importer_cache"), if you are clearing out entries in the dictionary of paths that do not have a finder, you will need to remove keys paired with values of `None` **and** `imp.NullImporter` to be backwards-compatible. This will lead to extra overhead on older versions of Python that re-insert `None` into [`sys.path_importer_cache`](3.标准库/sys.md#sys.path_importer_cache "sys.path_importer_cache") where it represents the use of implicit finders, but semantically it should not change anything.

  * `importlib.abc.Finder` no longer specifies a `find_module()` abstract method that must be implemented. If you were relying on subclasses to implement that method, make sure to check for the method's existence first. You will probably want to check for `find_loader()` first, though, in the case of working with [path entry finders](../glossary.md#term-path-entry-finder).

  * [`pkgutil`](pkgutil.md#module-pkgutil "pkgutil: Utilities for the import system.") has been converted to use [`importlib`](importlib.md#module-importlib "importlib: The implementation of the import machinery.") internally. This eliminates many edge cases where the old behaviour of the [**PEP 302**](https://peps.python.org/pep-0302/) import emulation failed to match the behaviour of the real import system. The import emulation itself is still present, but is now deprecated. The [`pkgutil.iter_importers()`](pkgutil.md#pkgutil.iter_importers "pkgutil.iter_importers") and [`pkgutil.walk_packages()`](pkgutil.md#pkgutil.walk_packages "pkgutil.walk_packages") functions special case the standard import hooks so they are still supported even though they do not provide the non-standard `iter_modules()` method.

  * A longstanding RFC-compliance bug ([bpo-1079](https://bugs.python.org/issue?@action=redirect&bpo=1079)) in the parsing done by [`email.header.decode_header()`](email.header.md#email.header.decode_header "email.header.decode_header") has been fixed. Code that uses the standard idiom to convert encoded headers into unicode (`str(make_header(decode_header(h))`) will see no change, but code that looks at the individual tuples returned by decode_header will see that whitespace that precedes or follows `ASCII` sections is now included in the `ASCII` section. Code that builds headers using `make_header` should also continue to work without change, since `make_header` continues to add whitespace between `ASCII` and non-`ASCII` sections if it is not already present in the input strings.

  * [`email.utils.formataddr()`](email.utils.md#email.utils.formataddr "email.utils.formataddr") now does the correct content transfer encoding when passed non-`ASCII` display names. Any code that depended on the previous buggy behavior that preserved the non-`ASCII` unicode in the formatted output string will need to be changed ([bpo-1690608](https://bugs.python.org/issue?@action=redirect&bpo=1690608)).

  * [`poplib.POP3.quit()`](poplib.md#poplib.POP3.quit "poplib.POP3.quit") may now raise protocol errors like all other `poplib` methods. Code that assumes `quit` does not raise [`poplib.error_proto`](poplib.md#poplib.error_proto "poplib.error_proto") errors may need to be changed if errors on `quit` are encountered by a particular application ([bpo-11291](https://bugs.python.org/issue?@action=redirect&bpo=11291)).

  * The `strict` argument to [`email.parser.Parser`](email.parser.md#email.parser.Parser "email.parser.Parser"), deprecated since Python 2.4, has finally been removed.

  * The deprecated method `unittest.TestCase.assertSameElements` has been removed.

  * The deprecated variable `time.accept2dyear` has been removed.

  * 被弃用的 `Context._clamp` 属性已从 [`decimal`](decimal.md#module-decimal "decimal: Implementation of the General Decimal Arithmetic  Specification.") 模块中移除。 在此之前它已被公有属性 `clamp` 取代。 （参见 [bpo-8540](https://bugs.python.org/issue?@action=redirect&bpo=8540)。）

  * The undocumented internal helper class `SSLFakeFile` has been removed from [`smtplib`](smtplib.md#module-smtplib "smtplib: SMTP protocol client \(requires sockets\)."), since its functionality has long been provided directly by [`socket.socket.makefile()`](socket.md#socket.socket.makefile "socket.socket.makefile").

  * Passing a negative value to [`time.sleep()`](time.md#time.sleep "time.sleep") on Windows now raises an error instead of sleeping forever. It has always raised an error on posix.

  * The `ast.__version__` constant has been removed. If you need to make decisions affected by the AST version, use [`sys.version_info`](3.标准库/sys.md#sys.version_info "sys.version_info") to make the decision.

  * Code that used to work around the fact that the [`threading`](threading.md#module-threading "threading: Thread-based parallelism.") module used factory functions by subclassing the private classes will need to change to subclass the now-public classes.

  * The undocumented debugging machinery in the threading module has been removed, simplifying the code. This should have no effect on production code, but is mentioned here in case any application debug frameworks were interacting with it ([bpo-13550](https://bugs.python.org/issue?@action=redirect&bpo=13550)).

### Porting C code¶

  * In the course of changes to the buffer API the undocumented `smalltable` member of the [`Py_buffer`](buffer.md#c.Py_buffer "Py_buffer") structure has been removed and the layout of the `PyMemoryViewObject` has changed.

All extensions relying on the relevant parts in `memoryobject.h` or `object.h` must be rebuilt.

  * Due to PEP 393, the [`Py_UNICODE`](10.C%20API接口/unicode.md#c.Py_UNICODE "Py_UNICODE") type and all functions using this type are deprecated (but will stay available for at least five years). If you were using low-level Unicode APIs to construct and access unicode objects and you want to benefit of the memory footprint reduction provided by [**PEP 393**](https://peps.python.org/pep-0393/), you have to convert your code to the new [Unicode API](10.C%20API接口/unicode.md).

However, if you only have been using high-level functions such as [`PyUnicode_Concat()`](10.C%20API接口/unicode.md#c.PyUnicode_Concat "PyUnicode_Concat"), [`PyUnicode_Join()`](10.C%20API接口/unicode.md#c.PyUnicode_Join "PyUnicode_Join") or [`PyUnicode_FromFormat()`](10.C%20API接口/unicode.md#c.PyUnicode_FromFormat "PyUnicode_FromFormat"), your code will automatically take advantage of the new unicode representations.

  * [`PyImport_GetMagicNumber()`](10.C%20API接口/import.md#c.PyImport_GetMagicNumber "PyImport_GetMagicNumber") now returns `-1` upon failure.

  * As a negative value for the _level_ argument to [`__import__()`](functions.md#import__ "__import__") is no longer valid, the same now holds for [`PyImport_ImportModuleLevel()`](10.C%20API接口/import.md#c.PyImport_ImportModuleLevel "PyImport_ImportModuleLevel"). This also means that the value of _level_ used by [`PyImport_ImportModuleEx()`](10.C%20API接口/import.md#c.PyImport_ImportModuleEx "PyImport_ImportModuleEx") is now `0` instead of `-1`.

### Building C extensions¶

  * The range of possible file names for C extensions has been narrowed. Very rarely used spellings have been suppressed: under POSIX, files named `xxxmodule.so`, `xxxmodule.abi3.so` and `xxxmodule.cpython-*.so` are no longer recognized as implementing the `xxx` module. If you had been generating such files, you have to switch to the other spellings (i.e., remove the `module` string from the file names).

(implemented in [bpo-14040](https://bugs.python.org/issue?@action=redirect&bpo=14040).)

### Command Line Switch Changes¶

  * The -Q command-line flag and related artifacts have been removed. Code checking sys.flags.division_warning will need updating.

（[bpo-10998](https://bugs.python.org/issue?@action=redirect&bpo=10998)，由 Éric Araujo 贡献。）

  * When **python** is started with [`-S`](1.%20命令行与环境.md#cmdoption-S), `import site` will no longer add site-specific paths to the module search paths. In previous versions, it did.

([bpo-11591](https://bugs.python.org/issue?@action=redirect&bpo=11591), contributed by Carl Meyer with editions by Éric Araujo.)

